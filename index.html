<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ceklisin - Aplikasi Monitoring Anak</title>

    <!-- TAG FAVICON BARU -->
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/a/AVvXsEgCQIvGG8OiiJjph8Nwgefo8_Oe34-EVu638IOWVQrxQLQXWcZQDNL-VJ387uftgwLAAY2haeOnSY7Ak8UtfsXo2qWVYWTmn0NnbEpEsCynhn15XGmd3fXadb1Tz3l3SNrVBIPOkcwA7l3k0MYdyMeGtLvuyL99P8umgElWg9hp5k4JsW99coph4AyGnb4">
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS (Library untuk membaca Excel/Spreadsheet) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Warna Utama */
        .bg-primary { background-color: #795ee2; }
        .text-primary { color: #795ee2; }
        .border-primary { border-color: #795ee2; }
        .hover-bg-primary:hover { background-color: #694cd1; }
        
        .bg-secondary { background-color: #fdc621; }
        .text-secondary { color: #dcb310; }
        .border-secondary { border-color: #fdc621; }
        
        /* LOGIKA TAMPILAN HALAMAN */
        .view-section {
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            height: 100%;
            width: 100%;
        }
        
        .view-section.active {
            display: block;
            opacity: 1;
        }

        /* Checkbox Styles */
        .ceklis-checkbox:checked + div {
            /* Ubah latar belakang menjadi warna sekunder yang lebih lembut */
            background-color: #fffbe6; /* Contoh warna kuning/jingga yang sangat muda */
            border-color: #fdc621; /* Warna batas/border menjadi Secondary */
        }
        .ceklis-checkbox:checked + div .icon-box {
            /* Warna kotak ikon saat diceklis. Biarkan primary atau ubah ke secondary. */
            background-color: #795ee2; /* Tetap Primary agar kontras */
            color: white;
        }
        .ceklis-checkbox:checked + div .check-indicator {
            /* Ubah warna indikator ceklis menjadi Secondary */
            background-color: #fdc621;
            border-color: #fdc621;
            opacity: 1;
            transform: scale(1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #795ee2;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar Active State */
        .sidebar-item.active {
            background-color: #f0ebff;
            color: #795ee2;
            border-right: 4px solid #795ee2;
            font-weight: 700;
        }
        
        /* Ensure elements are clickable */
        aside, button, a, input, select { pointer-events: auto !important; }
        
        /* Modal Transition */
        .modal {
            transition: opacity 0.25s ease, transform 0.2s ease;
        }
        body.modal-active {
            overflow-y: hidden !important;
        }
    </style>
</head>
<body class="flex justify-center min-h-screen bg-gray-200 overflow-x-hidden">

    <!-- Main App Container -->
    <div id="app-container" class="w-full max-w-lg bg-white h-screen shadow-2xl relative overflow-hidden flex flex-col transition-all duration-500 ease-in-out">
        
        <!-- Mobile Header -->
        <header class="bg-primary text-white p-4 shadow-md z-20 flex justify-between items-center transition-all duration-300 hidden" id="main-header">
            <div class="flex items-center gap-2">
                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEhyKY0BUVNJFWttDxVY2r0t_PaHXf48S18tgO1PhSXQ9Ei0V-DG-ugh61QjeSPmAaAuwPOdh4wHP9EYbVAEK8cmrFo8APddy29CrP4n8R3MxmN1jTNva9DNtnzXyK-lG-UEprDlApOg4gz2yRfRsq1L2LZhHVzxiOIBExJjC2KSTXhz8EXTesaF7cbOiHo" alt="Logo Ceklisin" class="h-8 object-contain">
            </div>
            <div class="flex items-center gap-3">
                <div id="global-loader" class="hidden loader border-white border-t-transparent"></div>
                <button type="button" onclick="logout()" id="logoutBtn" class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 transition border border-white/30 cursor-pointer relative z-50">
                    Keluar
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto no-scrollbar bg-gray-50 relative w-full h-full z-0">
            
            <!-- VIEW: LOGIN -->
            <section id="view-login" class="view-section active h-full bg-white relative z-50">
                <div class="w-full h-full flex flex-col justify-center items-center p-8">
                    <div class="text-center mb-10">
                        <div class="w-48 h-48 mx-auto mb-2 relative flex items-center justify-center">
                            <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgI3Y0j3lS8IcxhaiNKTuknC3P50foFe8xTo6cc8qescC9h0-L5ZICAqOmgP00ktHrXmahhBV50V1fKPml4F2NbRMyxtkrUvGfDr3pKQeyErh0PSblB1wFXCFm8tJZzY9nPaz_7QeMv6MQQjM_Fway_bS_W7p4w0AB_Rp9zsMAJsBRaa48rJlqv3Ww3WUo" alt="Logo Aplikasi" class="w-full h-full object-contain">
                        </div>
                        <p class="text-gray-400 text-lg">Aplikasi Monitoring Harian Anak</p>
                    </div>

                    <form onsubmit="handleLogin(event)" class="w-full space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Email / Nama User</label>
                            <input type="text" id="username" placeholder="Masukan nama atau email..." class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Password</label>
                            <input type="password" id="password" placeholder="***" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition">
                        </div>
                        
                        <button type="submit" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 mt-4 cursor-pointer">
                            Masuk
                        </button>
                    </form>
                </div>
            </section>

            <!-- VIEW: ADMIN CMS -->
            <section id="view-admin" class="view-section bg-gray-100 relative h-full">
                <div class="flex h-full relative">
                    <!-- Sidebar -->
                    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-lg z-40 h-full relative">
                        <div class="p-6 flex justify-center border-b border-gray-100">
                            <div class="w-28 h-28"> <!-- Atur lebar agar logo terlihat bagus -->
                                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgI3Y0j3lS8IcxhaiNKTuknC3P50foFe8xTo6cc8qescC9h0-L5ZICAqOmgP00ktHrXmahhBV50V1fKPml4F2NbRMyxtkrUvGfDr3pKQeyErh0PSblB1wFXCFm8tJZzY9nPaz_7QeMv6MQQjM_Fway_bS_W7p4w0AB_Rp9zsMAJsBRaa48rJlqv3Ww3WUo" alt="Logo Ceklisin Admin" class="w-full object-contain">
                            </div>
                        </div>
                        
                        <nav class="flex-1 p-4 space-y-2 overflow-y-auto relative z-50">
                            <button type="button" onclick="switchAdminTab('dashboard')" id="sidebar-dashboard" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 active cursor-pointer">
                                <i class="fas fa-chart-pie w-5"></i> Dashboard
                            </button>
                            <button type="button" onclick="switchAdminTab('schools')" id="sidebar-schools" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-university w-5"></i> Sekolah
                            </button>
                            <button type="button" onclick="switchAdminTab('admins')" id="sidebar-admins" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-user-shield w-5"></i> Data Admin
                            </button>
                            <button type="button" onclick="switchAdminTab('students')" id="sidebar-students" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-child w-5"></i> Data Murid
                            </button>
                            <button type="button" onclick="switchAdminTab('teachers')" id="sidebar-teachers" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-chalkboard-teacher w-5"></i> Data Guru
                            </button>
                            <button type="button" onclick="switchAdminTab('classes')" id="sidebar-classes" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-chalkboard w-5"></i> Data Kelas
                            </button>
                            <!-- PERBAIKAN: Mengubah <a> menjadi <button> dan memanggil switchAdminTab('tasks') -->
                            <button type="button" onclick="switchAdminTab('tasks')" id="sidebar-tasks" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-list-check w-5"></i> Data Task
                            </button>
                            <button type="button" onclick="switchAdminTab('settings')" id="sidebar-settings" class="sidebar-item w-full text-left px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-cog w-5"></i> Pengaturan
                            </button>
                        </nav>

                        <div class="p-4 border-t border-gray-100 bg-white relative z-50">
                            <button type="button" onclick="logout()" class="w-full text-left px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg text-sm font-bold transition flex items-center gap-2 cursor-pointer">
                                <i class="fas fa-sign-out-alt"></i> Keluar
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content -->
                    <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative z-0">
                        <!-- Topbar -->
                        <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center shadow-sm relative z-30">
                            <h2 class="text-xl font-bold text-gray-800" id="admin-page-title">Dashboard</h2>
                            <div class="flex items-center gap-3">
                                <div class="text-right mr-2">
                                    <p class="text-sm font-bold text-gray-700" id="admin-user-name">Admin</p>
                                    <p class="text-xs text-green-500" id="admin-user-role">Super Admin</p>
                                </div>
                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                        </header>

                        <!-- Content Body -->
                        <div class="flex-1 overflow-y-auto p-8 relative z-0" id="admin-content-scroll">
                            
                            <!-- TAB: DASHBOARD -->
                            <div id="admin-panel-dashboard" class="admin-tab-content">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-full bg-purple-100 text-primary flex items-center justify-center text-2xl">
                                            <i class="fas fa-child"></i>
                                        </div>
                                        <div>
                                            <p class="text-gray-500 text-sm">Total Murid</p>
                                            <h3 class="text-3xl font-bold text-gray-800" id="stat-student-count">-</h3>
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-2xl">
                                            <i class="fas fa-user-tie"></i>
                                        </div>
                                        <div>
                                            <p class="text-gray-500 text-sm">Total Guru</p>
                                            <h3 class="text-3xl font-bold text-gray-800" id="stat-teacher-count">-</h3>
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-2xl">
                                            <i class="fas fa-chalkboard"></i> <!-- Icon Kelas -->
                                        </div>
                                        <div>
                                            <p class="text-gray-500 text-sm">Total Kelas</p> <!-- Label Baru -->
                                            <h3 class="text-3xl font-bold text-gray-800" id="stat-class-count">-</h3> <!-- ID Baru: stat-class-count -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: SCHOOLS -->
                            <div id="admin-panel-schools" class="admin-tab-content hidden">
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
                                    <div class="flex justify-between items-center mb-6 relative z-10">
                                        <div class="flex flex-col">
                                            <h3 class="font-bold text-gray-700 text-lg">Daftar Sekolah</h3>
                                            <p class="text-xs text-gray-400">Kelola data sekolah partner.</p>
                                        </div>
                                        
                                        <button type="button" onclick="window.openSchoolModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#694cd1] flex items-center gap-2 cursor-pointer transition transform active:scale-95 relative z-50">
                                            <i class="fas fa-plus"></i> Tambah Sekolah
                                        </button>
                                    </div>

                                    <div class="overflow-x-auto rounded-lg border border-gray-100 relative z-0">
                                        <table class="w-full text-left border-collapse">
                                            <thead>
                                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                                    <th class="p-4 rounded-tl-lg">Nama Sekolah</th>
                                                    <th class="p-4">Kepala Sekolah</th>
                                                    <th class="p-4">Lokasi (Kota)</th>
                                                    <th class="p-4">Status</th>
                                                    <th class="p-4 text-center rounded-tr-lg">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-school-table-body" class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                                                <tr><td colspan="5" class="p-4 text-center text-gray-400">Memuat data sekolah...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: ADMINS -->
                            <div id="admin-panel-admins" class="admin-tab-content hidden">
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
                                    <div class="flex justify-between items-center mb-6 relative z-10">
                                        <div class="flex flex-col">
                                            <h3 class="font-bold text-gray-700 text-lg">Data Admin Sekolah</h3>
                                            <p class="text-xs text-gray-400">Kelola akun Admin Sekolah.</p>
                                        </div>
                                        
                                        <button type="button" onclick="window.openAdminModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#694cd1] flex items-center gap-2 cursor-pointer transition transform active:scale-95 relative z-50">
                                            <i class="fas fa-user-plus"></i> Tambah Admin
                                        </button>
                                    </div>

                                    <div class="overflow-x-auto rounded-lg border border-gray-100 relative z-0">
                                        <table class="w-full text-left border-collapse">
                                            <thead>
                                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                                    <th class="p-4 rounded-tl-lg">Nama</th>
                                                    <th class="p-4">Email</th>
                                                    <th class="p-4">Sekolah</th>
                                                    <th class="p-4">Status</th>
                                                    <th class="p-4 text-center rounded-tr-lg">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-admins-table-body" class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                                                <tr><td colspan="5" class="p-4 text-center text-gray-400">Memuat data admin...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: STUDENTS -->
                            <div id="admin-panel-students" class="admin-tab-content hidden">
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
                                    <div class="flex justify-between items-center mb-6 relative z-10">
                                        <div class="flex flex-col">
                                            <h3 class="font-bold text-gray-700 text-lg">Manajemen Data Murid</h3>
                                            <p class="text-xs text-gray-400">Kelola akun dan data siswa.</p>
                                        </div>
                                        
                                        <div class="flex gap-2"> <!-- Tambahkan div untuk menampung kedua tombol -->
                                            <!-- Tombol Import Data -->
                                            <button type="button" onclick="window.openImportStudentModal()" class="bg-secondary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#dcb310] flex items-center gap-2 cursor-pointer transition transform active:scale-95 relative z-50">
                                                <i class="fas fa-file-import"></i> Import Data
                                            </button>
                                            
                                            <!-- Tombol Tambah Murid (yang sudah ada) -->
                                            <button type="button" onclick="window.openStudentModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#694cd1] flex items-center gap-2 cursor-pointer transition transform active:scale-95 relative z-50">
                                                <i class="fas fa-user-plus"></i> Tambah Murid
                                            </button>
                                        </div>
                                    </div>

                                    <div class="overflow-x-auto rounded-lg border border-gray-100 relative z-0">
                                        <table class="w-full text-left border-collapse">
                                            <thead>
                                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                                    <th class="p-4 rounded-tl-lg">Nama Murid</th>
                                                    <th class="p-4">Email</th>
                                                    <th class="p-4">Sekolah</th>
                                                    <th class="p-4">Status</th>
                                                    <th class="p-4 text-center rounded-tr-lg">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-student-table-body" class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                                                <tr><td colspan="5" class="p-4 text-center text-gray-400">Memuat data murid...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TAB: CLASSES -->
                            <div id="admin-panel-classes" class="admin-tab-content hidden">
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
                                    <div class="flex justify-between items-center mb-6 relative z-10">
                                        <div class="flex flex-col">
                                            <h3 class="font-bold text-gray-700 text-lg">Manajemen Kelas</h3>
                                            <p class="text-xs text-gray-400">Daftar kelas dan wali kelas.</p>
                                        </div>
                                        
                                        <button type="button" onclick="window.openClassModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#694cd1] flex items-center gap-2 cursor-pointer transition transform active:scale-95 relative z-50">
                                            <i class="fas fa-plus"></i> Tambah Kelas
                                        </button>
                                    </div>

                                    <div class="overflow-x-auto rounded-lg border border-gray-100 relative z-0">
                                        <table class="w-full text-left border-collapse">
                                            <thead>
                                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                                    <th class="p-4 rounded-tl-lg">Nama Kelas</th>
                                                    <th class="p-4">Sekolah</th>
                                                    <th class="p-4">Wali Kelas</th>
                                                    <th class="p-4 text-center rounded-tr-lg">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-class-table-body" class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                                                <tr><td colspan="4" class="p-4 text-center text-gray-400">Memuat data kelas...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: CLASS MEMBERS LIST (Halaman Detail Murid Kelas) -->
                            <div id="admin-panel-class-members" class="admin-tab-content hidden">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-3">
                                        <button onclick="switchAdminTab('classes')" class="text-gray-500 hover:text-primary transition">
                                            <i class="fas fa-arrow-left text-xl"></i>
                                        </button>
                                        <h3 class="text-xl font-bold text-gray-800" id="class-members-title">Daftar Murid Kelas</h3>
                                    </div>
                                    
                                    <!-- Tombol Tambah Murid (akan memanggil modal dropdown baru) -->
                                    <button type="button" onclick="window.openStudentAssignmentModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#694cd1] flex items-center gap-2 cursor-pointer transition transform active:scale-95 relative z-50">
                                        <i class="fas fa-user-plus"></i> Tambah Murid
                                    </button>
                                </div>

                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                                    <div class="overflow-x-auto rounded-lg border border-gray-100 relative z-0">
                                        <table class="w-full text-left border-collapse">
                                            <thead>
                                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                                    <th class="p-4 rounded-tl-lg w-16">No.</th>
                                                    <th class="p-4">Nama Murid</th>
                                                    <th class="p-4 text-center rounded-tr-lg">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="class-members-table-body" class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                                                <tr><td colspan="3" class="p-4 text-center text-gray-400">Memuat data murid...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TAB: TEACHERS -->
                            <div id="admin-panel-teachers" class="admin-tab-content hidden">
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
                                    <div class="flex justify-between items-center mb-6 relative z-10">
                                        <div class="flex flex-col">
                                            <h3 class="font-bold text-gray-700 text-lg">Manajemen Guru</h3>
                                            <p class="text-xs text-gray-400">Kelola akun dan data wali kelas.</p>
                                        </div>
                                        
                                        <button type="button" onclick="window.openTeacherModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#694cd1] flex items-center gap-2 cursor-pointer transition transform active:scale-95 relative z-50">
                                            <i class="fas fa-user-plus"></i> Tambah Guru
                                        </button>
                                    </div>

                                    <div class="overflow-x-auto rounded-lg border border-gray-100 relative z-0">
                                        <table class="w-full text-left border-collapse">
                                            <thead>
                                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                                    <th class="p-4 rounded-tl-lg">Nama Guru</th>
                                                    <th class="p-4">Email</th>
                                                    <th class="p-4">Sekolah</th>
                                                    <th class="p-4">Status</th>
                                                    <th class="p-4 text-center rounded-tr-lg">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-teacher-table-body" class="text-sm text-gray-700 divide-y divide-gray-100 bg-white">
                                                <tr><td colspan="5" class="p-4 text-center text-gray-400">Memuat data guru...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: TASKS -->
                            <div id="admin-panel-tasks" class="admin-tab-content hidden">
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
                                    <div class="flex justify-between items-center mb-6 relative z-10">
                                        <h3 class="font-bold text-gray-700 text-lg">Daftar Tugas Harian (Tasks)</h3>
                                        <!-- Tombol Tambah Task -->
                                        <button type="button" id="addTaskBtn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-[#694cd1] transition duration-300" onclick="window.openTaskModal()">
                                            <i class="fas fa-plus"></i> Tambah Task
                                        </button>
                                    </div>

                                    <!-- Container untuk Tabel Task -->
                                    <div id="task-table-container" class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                                        <p class="text-center text-gray-500">Memuat data tasks...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: SETTINGS -->
                            <div id="admin-panel-settings" class="admin-tab-content hidden">
                                
                                <!-- Bagian Profil Sekolah -->
                                <div id="school-profile-container" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 relative">
                                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                                        <h3 class="font-bold text-gray-700 text-lg">Profil Sekolah</h3>
                                        <button type="button" onclick="window.openSchoolModal(currentUser.school_id)" id="edit-school-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition transform active:scale-95 flex items-center gap-2">
                                            <i class="fas fa-edit"></i> Edit Data
                                        </button>
                                    </div>

                                    <div id="school-details" class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 text-sm">
                                        <!-- Data akan dimuat di sini oleh JavaScript -->
                                        <p class="text-gray-500 col-span-2">Memuat data profil sekolah...</p>
                                    </div>
                                </div>
                                
                                <!-- Bagian Profil Admin -->
                                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                                    <h3 class="font-bold text-gray-700 text-lg mb-6 border-b pb-4">Profil Akun Admin</h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 text-sm mb-6">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 uppercase">Nama Admin</p>
                                            <p class="font-bold text-gray-800" id="admin-setting-name">-</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 uppercase">Email Login</p>
                                            <p class="font-bold text-gray-800" id="admin-setting-email">-</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 uppercase">Role</p>
                                            <p class="font-bold text-green-600" id="admin-setting-role">-</p>
                                        </div>
                                    </div>

                                    <button type="button" onclick="window.openPasswordChangeModal()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition transform active:scale-95 flex items-center gap-2">
                                        <i class="fas fa-lock"></i> Ubah Password
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: TEACHER/PARENT DASHBOARDS -->
            <section id="view-teacher-dashboard" class="view-section p-4">
                 <div class="flex justify-between items-end mb-4 px-1">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Daftar Murid</h2>
                        <p class="text-xs text-gray-400" id="teacher-date-display">-</p>
                    </div>
                    <div class="bg-white border px-3 py-1 rounded-full text-xs font-bold text-primary shadow-sm" id="user-role-badge">Wali Kelas</div>
                </div>
                <div id="student-list-teacher" class="grid grid-cols-2 gap-3 pb-24"></div>
            </section>

            <section id="view-teacher-checklist" class="view-section p-0 pb-24 h-full flex flex-col">
                <div class="bg-white p-4 shadow-sm border-b z-10 sticky top-0 flex flex-col gap-3">
                    <div class="flex items-center gap-3">
                        <button type="button" onclick="switchView('view-teacher-dashboard')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-600 hover:bg-gray-100 cursor-pointer">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h3 id="checklist-student-name" class="font-bold text-gray-800 text-lg leading-tight flex-1">Nama Anak</h3>
                    </div>
                    
                    <!-- Input Tanggal di Bawah Nama Murid -->
                    <div class="flex items-center justify-between border-t pt-3">
                        <label for="date-picker-teacher" class="text-sm text-gray-600 font-medium whitespace-nowrap">Pilih Tanggal Ceklis:</label>
                        <input type="date" id="date-picker-teacher" 
                            class="border rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-primary"
                            onchange="window.renderTeacherChecklist(new Date(this.value))">
                    </div>
                </div>
                <div class="p-4 space-y-3 overflow-y-auto flex-1 bg-gray-50" id="checklist-container"></div>
                <div class="p-4 bg-white border-t flex gap-2">
                    <input type="text" id="custom-note-input" placeholder="Catatan untuk Orang Tua..." class="flex-1 bg-gray-50 border rounded-lg px-3 py-2 text-sm">
                    <button onclick="window.saveNote()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold cursor-pointer">Simpan Catatan</button>
                </div>
            </section>

            <!-- VIEW: PARENT DASHBOARD -->
            <section id="view-parent-dashboard" class="view-section p-0 pb-24">
                <div class="bg-primary pt-6 pb-6 px-6 rounded-b-[2.5rem] shadow-lg relative text-center">
                    <h2 class="text-2xl font-bold text-white mb-1" id="parent-view-name">Nama Anak</h2>
                    <p class="text-purple-200 text-sm font-medium" id="parent-class-name">-</p>
                    <p class="text-xs text-purple-200 mt-2" id="parent-date">-</p>
                </div>
                
                <!-- Checklist dan Konten Utama -->
                <div class="mt-4 px-5 space-y-4">
                    <!-- HEADER DENGAN DATE PICKER -->
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 sm:mb-0">Daftar Ceklis Kegiatan</h3>
                        
                        <div class="flex items-center space-x-2">
                            <label for="date-picker-parent" class="text-sm text-gray-600 font-medium whitespace-nowrap">Pilih Tanggal:</label>
                            <input type="date" id="date-picker-parent" 
                                class="border rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-primary"
                                onchange="window.handleDateChange(this.value)">
                        </div>
                    </div>

                    <div id="parent-checklist-result">
                        <!-- Data Task akan dimuat di sini -->
                    </div>
                </div>
                
                <!-- Catatan Guru -->
                <div id="parent-note-display" class="hidden mx-5 mt-6 bg-yellow-50 border border-[#fdc621] rounded-xl p-4">
                    <p class="text-xs font-medium text-gray-700 mb-1">Catatan dari Wali Kelas:</p>
                    <p class="text-sm text-gray-600 italic" id="parent-note-text"></p>
                </div>
            </section>

            <!-- VIEW: PARENT PROFILE / AKUN -->
            <section id="view-parent-profile" class="view-section p-4 pb-24 h-full">
                <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-3" id="profile-page-title">Profil Pengguna & Akun</h2>
    
                <!-- Profil Pengguna -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-8">
                    <!-- Judul Bagian Berubah -->
                    <h3 class="font-bold text-primary text-lg mb-4 border-b border-primary/20 pb-2" id="profile-data-title">Data Pengguna</h3>
                    
                    <div class="grid grid-cols-1 gap-4 text-sm">
                        <!-- Nama Anak / Nama Guru -->
                        <div class="border-b pb-2">
                            <!-- Label diubah menjadi lebih generik -->
                            <p class="text-xs font-medium text-gray-500 uppercase" id="profile-name-label">Nama Pengguna</p>
                            <p class="font-bold text-gray-800" id="profile-name">-</p>
                        </div>
                                    <!-- Email -->
                        <div class="border-b pb-2">
                            <p class="text-xs font-medium text-gray-500 uppercase">Email Login</p>
                            <p class="font-bold text-gray-800" id="profile-email">-</p>
                        </div>
                        <!-- Sekolah -->
                        <div class="border-b pb-2">
                            <p class="text-xs font-medium text-gray-500 uppercase">Sekolah</p>
                            <p class="font-bold text-gray-800" id="profile-school">-</p>
                        </div>
                        <!-- Kelas -->
                        <div class="border-b pb-2">
                            <p class="text-xs font-medium text-gray-500 uppercase">Kelas</p>
                            <p class="font-bold text-gray-800" id="profile-class">-</p>
                        </div>
                        <!-- Wali Kelas -->
                        <div class="pb-2">
                            <p class="text-xs font-medium text-gray-500 uppercase">Wali Kelas</p>
                            <p class="font-bold text-gray-800" id="profile-teacher">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ubah Password -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <h3 class="font-bold text-primary text-lg mb-4 border-b border-primary/20 pb-2">Pengaturan Akun</h3>
                    <button type="button" onclick="window.openPasswordChangeModal()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-lg text-sm font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-lock"></i> Ubah Password
                    </button>
                    <button type="button" onclick="logout()" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg text-sm font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Keluar Akun
                    </button>
                </div>
            </section>

        </main>

        <!-- Navbar (Bottom) -->
        <nav id="bottom-nav" class="hidden bg-white border-t border-gray-200 p-2 pb-safe flex justify-around items-center z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <!-- Tombol Home -->
            <button onclick="window.navHome()" class="flex flex-col items-center gap-1 p-2 w-16 rounded-xl text-primary transition cursor-pointer">
                <i class="fas fa-home text-xl mb-0.5"></i><span class="text-[10px] font-bold">Home</span>
            </button>
            <!-- Tombol Akun (Panggil fungsi yang tepat sesuai role) -->
            <button onclick="window.renderProfileBasedOnRole()" class="flex flex-col items-center gap-1 p-2 w-16 rounded-xl text-secondary hover:text-primary transition cursor-pointer">
                <i class="fas fa-user text-xl mb-0.5"></i><span class="text-[10px] font-medium">Akun</span>
            </button>
        </nav>

        <!-- Toast Notification -->
        <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-sm px-6 py-3 rounded-full shadow-2xl z-[100] transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-2">
            <i class="fas fa-check-circle text-green-400"></i>
            <span id="toast-msg">Berhasil disimpan!</span>
        </div>

        <!-- MODAL UBAH PASSWORD (Di bagian Modal, sekitar baris 1080) -->
        <div id="passwordChangeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-transform scale-95">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Ubah Password Login</h3>
                    <button type="button" onclick="window.closePasswordChangeModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="passwordChangeForm" onsubmit="window.handlePasswordChange(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Password Baru</label>
                        <input type="password" name="new_password" id="input_new_password" placeholder="Minimal 6 karakter" class="w-full bg-gray-50 border rounded-xl p-3 text-sm focus:outline-none focus:border-primary" minlength="6" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Konfirmasi Password Baru</label>
                        <input type="password" name="confirm_password" id="input_confirm_password" class="w-full bg-gray-50 border rounded-xl p-3 text-sm focus:outline-none focus:border-primary" minlength="6" required>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="window.closePasswordChangeModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition cursor-pointer">Batal</button>
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 cursor-pointer">Ubah Password</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL SEKOLAH -->
        <div id="schoolModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-transform scale-95" id="schoolModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800" id="schoolModalTitle">Tambah Sekolah</h3>
                    <button type="button" onclick="window.closeSchoolModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="schoolForm" onsubmit="window.handleSchoolSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nama Sekolah</label>
                        <input type="text" name="school_name" id="input_school_name" placeholder="Contoh: SD Pertiwi" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Kepala Sekolah</label>
                        <input type="text" name="principal_name" id="input_principal_name" placeholder="Nama Kepala Sekolah" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Kota</label>
                            <input type="text" name="city" id="input_city" placeholder="Nama Kota" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Status</label>
                            <select name="status" id="input_status" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Alamat Lengkap</label>
                        <textarea name="address" id="input_address" rows="3" placeholder="Jl. Raya Bogor..." class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required></textarea>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="window.closeSchoolModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition cursor-pointer relative z-50">Batal</button>
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 cursor-pointer relative z-50">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL ADMIN -->
        <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-transform scale-95" id="adminModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800" id="adminModalTitle">Tambah Admin</h3>
                    <button type="button" onclick="window.closeAdminModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="adminForm" onsubmit="window.handleAdminSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nama Lengkap</label>
                        <input type="text" name="name" id="input_admin_name" placeholder="Nama Admin" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Email</label>
                        <input type="email" name="email" id="input_admin_email" placeholder="admin@sekolah.com" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Password</label>
                        <input type="password" name="password" id="input_admin_password" placeholder="Password Login" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" minlength="6">
                        <p class="text-[10px] text-gray-400 ml-1 mt-1">*Minimal 6 karakter. Wajib diisi untuk admin baru.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Sekolah</label>
                        <select name="school_id" id="input_admin_school" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary" required>
                            <option value="">Pilih Sekolah...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Status</label>
                        <select name="status" id="input_admin_status" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="window.closeAdminModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition cursor-pointer relative z-50">Batal</button>
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 cursor-pointer relative z-50">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- MODAL MURID -->
        <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-transform scale-95" id="studentModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800" id="studentModalTitle">Tambah Murid</h3>
                    <button type="button" onclick="window.closeStudentModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="studentForm" onsubmit="window.handleStudentSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nama Lengkap</label>
                        <input type="text" name="name" id="input_student_name" placeholder="Nama Murid" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Email</label>
                        <input type="email" name="email" id="input_student_email" placeholder="siswa@sekolah.com" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Password</label>
                        <input type="password" name="password" id="input_student_password" placeholder="Password Login" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" minlength="6">
                        <p class="text-[10px] text-gray-400 ml-1 mt-1">*Minimal 6 karakter.</p>
                    </div>
                    <div id="div_student_school_container">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Sekolah</label>
                        <select name="school_id" id="input_student_school" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary" required>
                            <option value="">Pilih Sekolah...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Status</label>
                        <select name="status" id="input_student_status" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="window.closeStudentModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition cursor-pointer relative z-50">Batal</button>
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 cursor-pointer relative z-50">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL IMPORT MURID -->
        <div id="importStudentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-xl shadow-2xl transform transition-transform scale-95" id="importStudentModalContent">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-xl font-bold text-gray-800">Import Data Murid (Bulk)</h3>
                    <button type="button" onclick="window.closeImportStudentModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="importStudentForm" onsubmit="window.handleImportStudentSubmit(event)" class="space-y-4">
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg">
                        <p class="font-bold text-sm text-yellow-800 mb-2 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> Format Wajib CSV / Tab</p>
                        <p class="text-xs text-yellow-700">Gunakan file Excel (.xlsx) dengan **SHEET PERTAMA** memiliki kolom urutan: **Nama, Email, Password**.</p>
                        <p class="text-xs text-yellow-700 mt-1">Contoh Baris: `Ani Budiman | ani.b@sekolah.com | password123`</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Pilih File Excel (.xlsx / .xls):</label>
                        <input type="file" id="import_file_input" accept=".xlsx,.xls" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="window.closeImportStudentModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition cursor-pointer relative z-50">Batal</button>
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 cursor-pointer relative z-50">
                            <i class="fas fa-upload mr-1"></i> Proses Import Data
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL GURU -->
        <div id="teacherModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-transform scale-95" id="teacherModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800" id="teacherModalTitle">Tambah Guru</h3>
                    <button type="button" onclick="window.closeTeacherModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="teacherForm" onsubmit="window.handleTeacherSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nama Lengkap</label>
                        <input type="text" name="name" id="input_teacher_name" placeholder="Nama Guru" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Email</label>
                        <input type="email" name="email" id="input_teacher_email" placeholder="guru@sekolah.com" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Password</label>
                        <input type="password" name="password" id="input_teacher_password" placeholder="Password Login" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" minlength="6">
                        <p class="text-[10px] text-gray-400 ml-1 mt-1">*Minimal 6 karakter.</p>
                    </div>
                    
                    <div id="div_teacher_school_container">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Sekolah</label>
                        <select name="school_id" id="input_teacher_school" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary" required>
                            <option value="">Pilih Sekolah...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Status</label>
                        <select name="status" id="input_teacher_status" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="window.closeTeacherModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition cursor-pointer relative z-50">Batal</button>
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 cursor-pointer relative z-50">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL KELAS -->
        <div id="classModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-transform scale-95" id="classModalContent">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800" id="classModalTitle">Tambah Kelas</h3>
                    <button type="button" onclick="window.closeClassModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="classForm" onsubmit="window.handleClassSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Nama Kelas</label>
                        <input type="text" name="class_name" id="input_class_name" placeholder="Contoh: Kelas 1A" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                    </div>
                    
                    <div id="div_class_school_container">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Sekolah</label>
                        <select name="school_id" id="input_class_school" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary" onchange="window.loadTeachersForClassModal(this.value)" required>
                            <option value="">Pilih Sekolah...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Wali Kelas</label>
                        <select name="teacher_id" id="input_class_teacher" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm text-gray-600 focus:outline-none focus:border-primary">
                            <option value="">Pilih Wali Kelas (Opsional)...</option>
                        </select>
                        <p class="text-[10px] text-gray-400 ml-1 mt-1">*Diambil dari data Guru sekolah terkait.</p>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="window.closeClassModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition cursor-pointer relative z-50">Batal</button>
                        <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95 cursor-pointer relative z-50">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL TAMBAH MURID KE KELAS (Dropdown Hanya untuk ADD) -->
        <div id="studentAssignmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-transform scale-95" id="studentAssignmentModalContent">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Tambahkan Murid</h3>
                        <p class="text-xs text-gray-400" id="assignment-modal-classname">Ke Kelas X</p>
                    </div>
                    <button type="button" onclick="window.closeStudentAssignmentModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form onsubmit="window.handleAssignStudent(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Pilih Murid:</label>
                        <select id="select_unassigned_student_only" class="w-full bg-gray-50 border rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                            <option value="">Memuat Murid...</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="window.closeStudentAssignmentModal()" class="bg-gray-100 text-gray-600 font-bold py-3 px-6 rounded-xl hover:bg-gray-200 transition">Batal</button>
                        <button type="submit" id="submit-assign-student" class="bg-primary text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95">Tambahkan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL KELOLA TASK BARU -->
        <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100] modal opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-6 w-full max-w-2xl shadow-2xl transform transition-transform scale-95" id="taskModalContent">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800" id="taskModalTitle">Tambah Task Baru</h3>
                        <p class="text-xs text-gray-400">Task berlaku untuk semua kelas di sekolah ini.</p>
                    </div>
                    <button type="button" onclick="window.closeTaskModal()" class="text-gray-400 hover:text-gray-600 transition cursor-pointer z-50 relative">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="taskForm" onsubmit="window.handleTaskSubmit(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Kolom Kiri: Detail Tugas -->
                        <div class="space-y-4">
                            <h4 class="font-bold text-primary border-b border-primary/20 pb-2">Detail Tugas</h4>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Nama Task (Contoh: Snack Pagi)</label>
                                <input type="text" name="task_name" id="input_task_name" class="w-full bg-gray-50 border rounded-xl p-3 text-sm focus:outline-none focus:border-primary" required>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Icon Font Awesome (Contoh: fas fa-utensils)</label>
                                <input type="text" name="icon_name" id="input_icon_name" placeholder="fas fa-utensils" class="w-full bg-gray-50 border rounded-xl p-3 text-sm focus:outline-none focus:border-primary">
                                <p class="text-[10px] text-gray-400 mt-1">Gunakan format Font Awesome (e.g., fas fa-book) atau biarkan kosong.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Color Code Tailwind (Contoh: text-pink-500)</label>
                                <input type="text" name="color_code" id="input_color_code" placeholder="text-primary atau text-red-500" class="w-full bg-gray-50 border rounded-xl p-3 text-sm focus:outline-none focus:border-primary">
                                <p class="text-[10px] text-gray-400 mt-1">Hanya class warna Tailwind (e.g., text-green-500).</p>
                            </div>
                        </div>

                        <!-- Kolom Kanan: Mapping Kelas dan Hari -->
                        <div class="space-y-4">
                            <h4 class="font-bold text-primary border-b border-primary/20 pb-2">Penjadwalan Tugas (Task Maps)</h4>
                            
                            <div id="class-mapping-container" class="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-200 h-[380px] overflow-y-auto">
                                <p class="text-sm text-gray-500 text-center">Memuat daftar kelas...</p>
                            </div>

                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="window.closeTaskModal()" class="bg-gray-100 text-gray-600 font-bold py-3 px-6 rounded-xl hover:bg-gray-200 transition">Batal</button>
                        <button type="submit" id="submit-task-modal" class="bg-primary text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-purple-200 hover:bg-[#694cd1] transition transform active:scale-95">Simpan Task</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://wtcotslofcztuaqbycuz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0Y290c2xvZmN6dHVhcWJ5Y3V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1OTI2MTEsImV4cCI6MjA3ODE2ODYxMX0.S6LjelEhKge_sqTchYysG2RRArb0Swq9tHQWKn4BzcU';
        
        // --- SAFE SUPABASE INITIALIZATION ---
        let supabase = null;
        try {
            if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else if (typeof createClient !== 'undefined') {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else if (window.supabase) {
                 supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch(err) { console.error("Supabase Init Error:", err); }

        const TASKS_CONFIG = [
            { id: 'datang', label: 'Tiba di Sekolah', icon: 'fa-sun', color: 'text-orange-400' },
            { id: 'snack_pagi', label: 'Snack Pagi', icon: 'fa-cookie-bite', color: 'text-pink-400' },
            { id: 'belajar', label: 'Belajar & Bermain', icon: 'fa-shapes', color: 'text-blue-400' },
            { id: 'makan_siang', label: 'Makan Siang', icon: 'fa-utensils', color: 'text-green-400' },
            { id: 'tidur', label: 'Tidur Siang', icon: 'fa-bed', color: 'text-indigo-400' },
            { id: 'susu', label: 'Minum Susu', icon: 'fa-glass-water', color: 'text-cyan-400' },
            { id: 'bab', label: 'Buang Air Besar', icon: 'fa-toilet', color: 'text-amber-600' },
            { id: 'pulang', label: 'Dijemput Pulang', icon: 'fa-car-side', color: 'text-purple-400' }
        ];

        let currentUser = null;
        let currentStudentId = null;
        let currentDailyData = { tasks: {}, note: '' }; 
        let schoolsDataCache = [];
        let adminsDataCache = [];
        let editingSchoolId = null;
        let editingAdminId = null;
        let editingStudentId = null;
        let editingTeacherId = null;
        let editingClassId = null;
        let currentClassId = null; // ID Kelas yang sedang dilihat di halaman detail murid
        let currentClassName = ''; // Nama Kelas yang sedang dilihat di halaman detail murid
        let activeView = 'dashboard-view';
        let schools = []; // Data sekolah yang sudah ada
        let classes = []; // Data kelas yang sudah ada
        let tasks = []; // Variabel untuk menyimpan data tugas
        const DAY_NAMES = ['Tidak Aktif', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
        let editingTaskId = null; // Variabel global untuk menyimpan ID task yang sedang diedit
        let currentViewDate = new Date();
        currentViewDate.setHours(12, 0, 0, 0);
        // --- STATE BARU UNTUK CEKLIS GURU ---
        let currentChecklistStudentId = null;
        let currentDailyActivityId = null;

        // --- GLOBAL FUNCTIONS ---
        
        // --- UTILITY FUNCTIONS ---
        function setLoader(state) {
            const loader = document.getElementById('global-loader');
            if (loader) {
                if (state) loader.classList.remove('hidden');
                else loader.classList.add('hidden');
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            
            if (toast && toastMsg) {
                // ... (seluruh isi fungsi showToast yang sudah kita buat) ...
                toastMsg.innerText = message;
                
                // Reset colors
                toast.classList.remove('bg-red-600', 'bg-gray-900');
                toast.querySelector('i').classList.remove('text-green-400', 'text-red-400', 'fa-check-circle', 'fa-exclamation-triangle');
                
                if (isError) {
                    toast.classList.add('bg-red-600');
                    toast.querySelector('i').classList.add('text-red-400', 'fa-exclamation-triangle');
                } else {
                    toast.classList.add('bg-gray-900');
                    toast.querySelector('i').classList.add('text-green-400', 'fa-check-circle');
                }

                toast.classList.remove('opacity-0', 'translate-y-[-20px]');
                toast.classList.add('opacity-100', 'translate-y-[0px]');
                
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-[0px]');
                    toast.classList.add('opacity-0', 'translate-y-[-20px]');
                }, 3000);
            }
        }

        async function getCurrentUserData(userId) {
            if (!userId) return null;
            const { data: user, error } = await supabase.from('users').select('*').eq('id', userId).single();
            
            if (error || !user) {
                console.error("Error fetching user data for session:", error);
                return null;
            }

            return user;
        }

        window.openSchoolModal = function(schoolId = null) {
            const modal = document.getElementById('schoolModal');
            const content = document.getElementById('schoolModalContent');
            const form = document.getElementById('schoolForm');
            const title = document.getElementById('schoolModalTitle');

            if(!modal || !form) return;

            form.reset();
            
            if (schoolId) {
                editingSchoolId = schoolId;
                if(title) title.innerText = "Edit Data Sekolah";
                const school = schoolsDataCache.find(s => s.id == schoolId);
                if (school) {
                    if(document.getElementById('input_school_name')) document.getElementById('input_school_name').value = school.school_name || '';
                    if(document.getElementById('input_principal_name')) document.getElementById('input_principal_name').value = school.principal_name || '';
                    if(document.getElementById('input_city')) document.getElementById('input_city').value = school.city || '';
                    if(document.getElementById('input_status')) document.getElementById('input_status').value = school.status || 'active';
                    if(document.getElementById('input_address')) document.getElementById('input_address').value = school.address || '';
                }
            } else {
                editingSchoolId = null;
                if(title) title.innerText = "Tambah Sekolah Baru";
            }

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            if(content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
            document.body.classList.add('modal-active');
        };

        window.closeSchoolModal = function() {
            const modal = document.getElementById('schoolModal');
            const content = document.getElementById('schoolModalContent');
            if(!modal) return;
            modal.classList.add('opacity-0');
            if(content) content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.handleSchoolSubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = {
                school_name: formData.get('school_name'),
                principal_name: formData.get('principal_name'),
                city: formData.get('city'),
                address: formData.get('address'),
                status: formData.get('status')
            };

            setLoader(true);
            let error = null;
            if (editingSchoolId) {
                const res = await supabase.from('schools').update(payload).eq('id', editingSchoolId);
                error = res.error;
            } else {
                const res = await supabase.from('schools').insert([payload]);
                error = res.error;
            }
            setLoader(false);

            if(error) {
                showToast("Gagal menyimpan data");
                console.error(error);
            } else {
                window.closeSchoolModal();
                showToast("Data tersimpan");
                fetchAndRenderSchools();
            }
        };

        window.deleteSchool = async function(id) {
            if(!confirm('Hapus sekolah ini?')) return;
            setLoader(true);
            const { error } = await supabase.from('schools').delete().eq('id', id);
            setLoader(false);
            if(error) showToast("Gagal menghapus");
            else fetchAndRenderSchools();
        };

        window.openAdminModal = async function(adminId = null) {
            const modal = document.getElementById('adminModal');
            const content = document.getElementById('adminModalContent');
            const form = document.getElementById('adminForm');
            const title = document.getElementById('adminModalTitle');
            const schoolSelect = document.getElementById('input_admin_school');

            if(!modal || !form) return;

            if(schoolsDataCache.length === 0) {
                await fetchAndRenderSchools(); 
            }
            
            schoolSelect.innerHTML = '<option value="">Pilih Sekolah...</option>';
            schoolsDataCache.forEach(school => {
                schoolSelect.innerHTML += `<option value="${school.id}">${school.school_name}</option>`;
            });

            form.reset();
            
            if (adminId) {
                editingAdminId = adminId;
                if(title) title.innerText = "Edit Data Admin";
                const admin = adminsDataCache.find(a => a.id == adminId);
                if (admin) {
                    if(document.getElementById('input_admin_name')) document.getElementById('input_admin_name').value = admin.name || '';
                    if(document.getElementById('input_admin_email')) document.getElementById('input_admin_email').value = admin.email || '';
                    if(document.getElementById('input_admin_school')) document.getElementById('input_admin_school').value = admin.school_id || '';
                    if(document.getElementById('input_admin_status')) document.getElementById('input_admin_status').value = admin.status || 'active';
                    if(document.getElementById('input_admin_password')) document.getElementById('input_admin_password').placeholder = "(Biarkan kosong jika tidak diganti)";
                }
            } else {
                editingAdminId = null;
                if(title) title.innerText = "Tambah Admin Baru";
                if(document.getElementById('input_admin_password')) document.getElementById('input_admin_password').placeholder = "Password Login";
            }

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            if(content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
            document.body.classList.add('modal-active');
        };

        window.closeAdminModal = function() {
            const modal = document.getElementById('adminModal');
            const content = document.getElementById('adminModalContent');
            if(!modal) return;
            modal.classList.add('opacity-0');
            if(content) content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.handleAdminSubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const email = formData.get('email');
            const password = formData.get('password');
            const school_id = formData.get('school_id');
            const status = formData.get('status');
            
            setLoader(true);
            let error = null;
            let userId = editingAdminId;

            try {
                if (!editingAdminId) {
                    if(!password || password.length < 6) {
                         setLoader(false);
                         return alert("Password wajib diisi minimal 6 karakter untuk admin baru.");
                    }

                    const tempSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: { persistSession: false }
                    });

                    const { data: authData, error: authError } = await tempSupabase.auth.signUp({
                        email: email,
                        password: password
                    });

                    if(authError) throw authError;
                    if(!authData.user) throw new Error("Gagal mendapatkan User ID dari Auth.");

                    userId = authData.user.id;
                }

                const payload = {
                    name: name,
                    email: email,
                    school_id: school_id,
                    status: status,
                    role: 'admin_sekolah'
                };

                if (editingAdminId) {
                    const res = await supabase.from('users').update(payload).eq('id', userId);
                    error = res.error;
                } else {
                    payload.id = userId;
                    const res = await supabase.from('users').insert([payload]);
                    error = res.error;
                }

            } catch(err) {
                error = err;
            }

            setLoader(false);

            if(error) {
                showToast("Gagal: " + (error.message || "Error Database"));
                console.error(error);
            } else {
                window.closeAdminModal();
                showToast("Admin berhasil disimpan & didaftarkan");
                fetchAndRenderAdmins();
            }
        };

        window.deleteAdmin = async function(id) {
            if(!confirm('Hapus admin ini?')) return;
            setLoader(true);
            const { error } = await supabase.from('users').delete().eq('id', id);
            setLoader(false);
            if(error) showToast("Gagal menghapus admin");
            else fetchAndRenderAdmins();
        };

        window.handleLogin = async function(e) {
            e.preventDefault();
            // Kita harus mengasumsikan input 'username' adalah EMAIL untuk Autentikasi Supabase.
            const email = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if(!email || !password) return alert("Email dan Password wajib diisi.");

            setLoader(true);
            let error = null;
            let authUser = null;
            let userDetails = null;

            try {
                // 1. SIGN IN DENGAN SUPABASE AUTH (Wajib untuk Persistency)
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (authError) throw authError;
                authUser = authData.user;
                if (!authUser) throw new Error("Gagal Auth: User tidak ditemukan setelah sign-in.");

                // 2. AMBIL DETAIL USER DARI TABEL 'USERS'
                // Kita mengambil detail role, school_id, dll. dari tabel public.users
                const { data: user, error: userError } = await supabase.from('users').select('*').eq('id', authUser.id).maybeSingle();
                
                if (userError) throw userError;
                if (!user) throw new Error("Detail user tidak ditemukan di tabel users.");
                userDetails = user;

            } catch (err) {
                error = err;
            }
            
            setLoader(false);

            if (error) {
                console.error("Login Error:", error);
                showToast("Login Gagal: Cek email/password Anda. " + (error.message || ""), true);
                return;
            }
            
            // --- 3. LOGIKA REDIRECT BERDASARKAN ROLE ---
            const role = userDetails.role ? userDetails.role.toLowerCase() : '';
            
            if (['super_admin', 'admin_sekolah'].includes(role)) {
                currentUser = { 
                    role: 'admin', 
                    name: userDetails.name, 
                    id: userDetails.id,
                    school_id: userDetails.school_id,      
                    specific_role: userDetails.role        
                };
                
                // ... (sisa logika admin, termasuk set nama dan role label) ...
                document.getElementById('admin-user-name').innerText = userDetails.name;
                const roleLabel = role === 'super_admin' ? 'Super Admin' : 'Admin Sekolah';
                document.getElementById('admin-user-role').innerText = roleLabel;
                
                const sidebarSchools = document.getElementById('sidebar-schools');
                const sidebarAdmins = document.getElementById('sidebar-admins');

                if (role === 'super_admin') {
                    sidebarSchools.classList.remove('hidden');
                    sidebarAdmins.classList.remove('hidden');
                } else {
                    sidebarSchools.classList.add('hidden');
                    sidebarAdmins.classList.add('hidden');
                }

                switchView('view-admin');
                
                // Fetch data dashboard (umum)
                fetchAndRenderStudents('admin');
                fetchAndRenderTeachers();
                fetchAndRenderClassCount();

                
                // Fetch data khusus Super Admin agar tidak error jika dipanggil
                if (role === 'super_admin') {
                    fetchAndRenderSchools();
                    fetchAndRenderAdmins();
                }

            } else if (role === 'wali_kelas') { 
                currentUser = { 
                    role: 'teacher', 
                    name: userDetails.name,
                    email: userDetails.email, 
                    id: userDetails.id,
                    school_id: userDetails.school_id,      
                    specific_role: userDetails.role
                };
                // PERBAIKAN: Gunakan userDetails.id dan set ke currentTeacherId
                currentTeacherId = userDetails.id; 
                
                switchView('view-teacher-dashboard');
                fetchAndRenderStudents('teacher'); // Panggil fetch data

            } else if (role === 'murid') { // <-- Blok Murid (Pastikan ini yang seharusnya ada setelah Wali Kelas)
                currentUser = { 
                    role: 'parent', 
                    name: userDetails.name, 
                    email: userDetails.email, 
                    id: userDetails.id,
                    school_id: userDetails.school_id,      
                    specific_role: userDetails.role
                };
                currentStudentId = userDetails.id; 
                switchView('view-parent-dashboard');
                renderParentView();
            }
        };

        window.logout = function() {
            currentUser = null;
            if(document.getElementById('username')) document.getElementById('username').value = '';
            if(document.getElementById('password')) document.getElementById('password').value = '';
            
            // Hard reset container layout
            const container = document.getElementById('app-container');
            if(container) {
                container.className = 'w-full max-w-lg bg-white h-screen shadow-2xl relative overflow-hidden flex flex-col transition-all duration-500 ease-in-out';
            }

            switchView('view-login');
        };

        // --- FUNGSI SESI PERSISTENCE ---
        async function checkSessionAndRender() {
            setLoader(true);
            
            // Supabase secara otomatis mencoba memuat sesi dari local storage.
            const { data: sessionData } = await supabase.auth.getSession();
            const session = sessionData?.session;

            if (session && session.user) {
                // Jika sesi ada, ambil data user dari tabel 'users'
                const user = await getCurrentUserData(session.user.id);

                if (user) {
                    const role = user.role ? user.role.toLowerCase() : '';
                    
                    // Set currentUser global
                    currentUser = { 
                        role: role.includes('admin') ? 'admin' : role, 
                        name: user.name, 
                        id: user.id,
                        school_id: user.school_id,      
                        specific_role: user.role        
                    };
                    
                    // Redirect ke view sesuai role
                    if (['super_admin', 'admin_sekolah'].includes(role)) {
                        // Set detail admin di sidebar
                        document.getElementById('admin-user-name').innerText = user.name;
                        const roleLabel = role === 'super_admin' ? 'Super Admin' : 'Admin Sekolah';
                        document.getElementById('admin-user-role').innerText = roleLabel;
                        
                        // Tampilkan/sembunyikan menu sesuai role
                        document.getElementById('sidebar-schools').classList.toggle('hidden', role !== 'super_admin');
                        document.getElementById('sidebar-admins').classList.toggle('hidden', role !== 'super_admin');
                        
                        switchView('view-admin');
                        fetchAndRenderClassCount();

                    } else if (role === 'wali_kelas') { // <-- GANTI DARI 'guru' ke 'wali_kelas' jika belum
                        currentUser = { 
                            role: 'teacher', 
                            name: user.name, 
                            email: user.email, // <--- TAMBAH properti email
                            id: user.id,
                            school_id: user.school_id
                        };
                        currentTeacherId = user.id; 
                        switchView('view-teacher-dashboard');
                        fetchAndRenderStudents('teacher'); // Panggil fetch data

                    } else if (role === 'murid') {
                        currentUser = { 
                            role: 'parent', 
                            name: user.name,
                            email: user.email, 
                            id: user.id,
                            school_id: user.school_id,      
                            specific_role: user.role
                        };
                        currentStudentId = user.id; 
                        switchView('view-parent-dashboard');
                        window.renderParentView(); // <-- Panggil tanpa parameter
                    }

                } else {
                    // Data user tidak valid, log out
                    await supabase.auth.signOut();
                    switchView('view-login');
                }
            } else {
                // Tidak ada sesi, tetap di halaman login
                switchView('view-login');
            }

            setLoader(false);
        }

        window.switchView = function(viewId) {
            const container = document.getElementById('app-container');
            
            // 1. Hide ALL sections manually (Safety Check)
            document.querySelectorAll('.view-section').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
                el.style.opacity = '0';
            });

            // 2. Show TARGET with delay for smooth transition
            const target = document.getElementById(viewId);
            if(target) {
                target.style.display = 'block'; // FORCE DISPLAY BLOCK
                
                // Use slight timeout to allow display:block to paint before opacity
                setTimeout(() => {
                    target.classList.add('active');
                    target.style.opacity = '1';
                }, 10);
            }
            
            const nav = document.getElementById('bottom-nav');
            const header = document.getElementById('main-header');

            if (viewId === 'view-admin') {
                container.classList.remove('max-w-lg', 'shadow-2xl');
                container.classList.add('w-full', 'max-w-none', 'bg-gray-100');
                
                nav.classList.add('hidden');
                header.classList.add('hidden');
                window.switchAdminTab('dashboard');
            } else {
                container.classList.add('max-w-lg', 'shadow-2xl');
                container.classList.remove('max-w-none', 'bg-gray-100');
                container.classList.add('w-full', 'bg-white');

                if (viewId === 'view-login') {
                    nav.classList.add('hidden');
                    header.classList.add('hidden');
                } else {
                    header.classList.remove('hidden');
                    if(viewId.includes('dashboard') || viewId.includes('profile')) nav.classList.remove('hidden');
                    else nav.classList.add('hidden');
                }
            }
        };

        window.switchAdminTab = function(tabName) {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const activeLink = document.getElementById(`sidebar-${tabName}`);
            if(activeLink) activeLink.classList.add('active');

            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
            const activeContent = document.getElementById(`admin-panel-${tabName}`);
            if(activeContent) activeContent.classList.remove('hidden');

            const titleEl = document.getElementById('admin-page-title');
            if(titleEl) {
                if (tabName === 'admins') titleEl.innerText = "Data Admin";
                else if (tabName === 'class-members') titleEl.innerText = "Manajemen Kelas";
                else if (tabName === 'tasks') titleEl.innerText = "Data Task";
                else titleEl.innerText = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            }
            
            // Perluasan logika fetch data
            if(tabName === 'schools') fetchAndRenderSchools();
            if(tabName === 'admins') fetchAndRenderAdmins();
            if(tabName === 'students') fetchAndRenderStudents('admin');
            if(tabName === 'teachers') fetchAndRenderTeachers();
            if(tabName === 'classes') fetchAndRenderClasses();
            if(tabName === 'tasks') fetchTasksAndMaps(); // Panggil fungsi fetch task baru
            if(tabName === 'settings') renderSettingsView();
            
            // Khusus: Jika kembali ke halaman detail kelas, jangan fetch apa-apa
            // Logika fetch dilakukan di openClassMembersView
        };

        async function fetchAndRenderSchools() {
            setLoader(true);
            const { data: schools } = await supabase.from('schools').select('*').order('school_name', { ascending: true });
            setLoader(false);

            schoolsDataCache = schools || [];
            const container = document.getElementById('admin-school-table-body');
            if(container) {
                container.innerHTML = '';
                if(!schools || schools.length === 0) {
                    container.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Belum ada data.</td></tr>';
                } else {
                    schools.forEach(s => {
                        container.innerHTML += `
                            <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                                <td class="p-4 font-bold text-gray-800">${s.school_name}</td>
                                <td class="p-4 text-gray-600">${s.principal_name || '-'}</td>
                                <td class="p-4 text-gray-600">${s.city || '-'}</td>
                                <td class="p-4"><span class="bg-green-100 text-green-600 px-2 py-1 rounded text-xs font-bold uppercase">${s.status}</span></td>
                                <td class="p-4 text-center">
                                    <div class="flex justify-center gap-2 relative z-10">
                                        <button type="button" onclick="window.openSchoolModal('${s.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded transition cursor-pointer relative z-50">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" onclick="window.deleteSchool('${s.id}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition cursor-pointer relative z-50">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            if(document.getElementById('stat-school-count')) document.getElementById('stat-school-count').innerText = schools ? schools.length : 0;
        }

        async function fetchAndRenderAdmins() {
            setLoader(true);
            if (schoolsDataCache.length === 0) {
                const { data: schools } = await supabase.from('schools').select('*');
                schoolsDataCache = schools || [];
            }
            
            const { data: admins } = await supabase
                .from('users')
                .select('*')
                .eq('role', 'admin_sekolah')
                .order('name', { ascending: true });
                
            setLoader(false);
            adminsDataCache = admins || [];

            const container = document.getElementById('admin-admins-table-body');
            if(container) {
                container.innerHTML = '';
                if(!admins || admins.length === 0) {
                    container.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Belum ada admin.</td></tr>';
                } else {
                    admins.forEach(admin => {
                        const school = schoolsDataCache.find(s => s.id == admin.school_id);
                        const schoolName = school ? school.school_name : '-';
                        const statusColor = admin.status === 'active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600';

                        container.innerHTML += `
                            <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                                <td class="p-4 font-bold text-gray-800">${admin.name}</td>
                                <td class="p-4 text-gray-600 text-sm">${admin.email || '-'}</td>
                                <td class="p-4 text-gray-600 text-sm">${schoolName}</td>
                                <td class="p-4"><span class="${statusColor} px-2 py-1 rounded text-xs font-bold uppercase">${admin.status || 'Active'}</span></td>
                                <td class="p-4 text-center">
                                    <div class="flex justify-center gap-2 relative z-10">
                                        <button type="button" onclick="window.openAdminModal('${admin.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded transition cursor-pointer relative z-50">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" onclick="window.deleteAdmin('${admin.id}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition cursor-pointer relative z-50">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
            }
        }

        async function fetchAndRenderStudents(role) {
            setLoader(true);
            
            // Variabel untuk menyimpan hasil akhir query students (Dipindahkan ke scope aman)
            let students = null; 
            let classNameForTeacher = 'Kelas Belum Ditentukan'; 
            
            // Pastikan data sekolah ada untuk mapping nama sekolah
            if (role === 'admin' && schoolsDataCache.length === 0) {
                const { data: schools } = await supabase.from('schools').select('*');
                schoolsDataCache = schools || [];
            }

            let studentIdsToFetch = [];
            let query = supabase.from('users').select('*').eq('role', 'murid');

            // --- LOGIKA FILTER BERDASARKAN ROLE ---
            if (role === 'admin' && currentUser.specific_role === 'admin_sekolah') {
                // Admin Sekolah: Ambil murid dari sekolahnya saja
                query = query.eq('school_id', currentUser.school_id);
                const { data } = await query.order('name', { ascending: true });
                students = data;

            } else if (role === 'teacher') {
                // Wali Kelas: 
                // 1. Cari kelas yang diampu oleh guru ini
                const { data: classMap } = await supabase.from('teachers_maps').select('class_id, classes(class_name)').eq('user_id', currentUser.id).maybeSingle();
                
                if (classMap) {
                    currentClassId = classMap.class_id;
                    classNameForTeacher = classMap.classes.class_name;
                    
                    // 2. Cari semua user_id murid yang terdaftar di kelas tersebut
                    const { data: studentMaps } = await supabase.from('students_maps').select('user_id').eq('class_id', currentClassId);
                    
                    if (studentMaps) {
                        studentIdsToFetch = studentMaps.map(m => m.user_id);
                        // 3. Filter query murid HANYA berdasarkan ID yang didapat
                        if (studentIdsToFetch.length > 0) {
                            query = query.in('id', studentIdsToFetch);
                            const { data } = await query.order('name', { ascending: true });
                            students = data; // <--- Definisikan di sini
                        } else {
                            // Jika kelas ada, tapi tidak ada murid terdaftar -> Early Exit
                            setLoader(false);
                            const container = document.getElementById('student-list-teacher');
                            if(container) container.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-4">Belum ada murid di kelas Anda.</div>';
                            return; // FUNGSI KELUAR SEBELUM MENCAPAI BARIS 1362
                        }
                    } else {
                        // Jika guru mengampu kelas, tapi query student maps gagal -> Early Exit
                        setLoader(false);
                        const container = document.getElementById('student-list-teacher');
                        if(container) container.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-4">Gagal memuat daftar murid.</div>';
                        return; // FUNGSI KELUAR
                    }
                } else {
                    // Jika guru tidak mengampu kelas -> Early Exit
                    setLoader(false);
                    const container = document.getElementById('student-list-teacher');
                    if(container) container.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-4">Anda belum ditugaskan sebagai wali kelas.</div>';
                    return; // FUNGSI KELUAR
                }
            
            } else {
                // Admin Super: Ambil semua murid
                const { data } = await query.order('name', { ascending: true });
                students = data;
            }
            // --- AKHIR LOGIKA FILTER ---

            // setLoader(false); // Dihapus karena sudah ada di dalam blok if/else

            const container = document.getElementById(role === 'admin' ? 'admin-student-table-body' : 'student-list-teacher');
            if(!container) return;
            container.innerHTML = '';

            // CEK students DISINI
            if(!students || students.length === 0) {
                container.innerHTML = role === 'admin' ? '<tr><td colspan="5" class="p-4 text-center text-gray-400">Belum ada murid.</td></tr>' : '<div class="col-span-2 text-center text-gray-400 py-4">Belum ada murid</div>';
            } else {
                students.forEach(s => {
                    if (role === 'admin') {
                        // TAMPILAN ADMIN: TABEL LENGKAP
                        const school = schoolsDataCache.find(sch => sch.id == s.school_id);
                        const schoolName = school ? school.school_name : '-';
                        const statusColor = s.status === 'active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600';
                        
                        container.innerHTML += `
                            <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                                <td class="p-4 font-bold text-gray-800">${s.name}</td>
                                <td class="p-4 text-gray-600 text-sm">${s.email || '-'}</td>
                                <td class="p-4 text-gray-600 text-sm">${schoolName}</td>
                                <td class="p-4"><span class="${statusColor} px-2 py-1 rounded text-xs font-bold uppercase">${s.status || 'active'}</span></td>
                                <td class="p-4 text-center">
                                    <div class="flex justify-center gap-2 relative z-10">
                                        <button type="button" onclick="window.openStudentModal('${s.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded transition cursor-pointer relative z-50">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" onclick="window.deleteStudent('${s.id}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition cursor-pointer relative z-50">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        // TAMPILAN GURU: KARTU
                        container.innerHTML += `
                            <div onclick="window.openChecklist('${s.id}', '${s.name}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer text-center hover:bg-gray-50 transition transform active:scale-95">
                                <div class="w-16 h-16 rounded-full mx-auto mb-2 bg-gray-100 flex items-center justify-center text-gray-500 text-3xl">
                                    <i class="fas fa-user-circle"></i> <!-- ICON PROFIL STANDAR -->
                                </div>
                                <h3 class="font-bold text-sm line-clamp-1 text-gray-800">${s.name}</h3>
                                <p class="text-xs text-gray-500 line-clamp-1">${classNameForTeacher}</p>
                            </div>
                        `;
                    }
                });
            }
            if(document.getElementById('stat-student-count')) document.getElementById('stat-student-count').innerText = students ? students.length : 0;
            
            setLoader(false); // Pindahkan setLoader(false) ke bagian akhir yang pasti tercapai
        }

        async function fetchAndRenderTeachers() {
            setLoader(true);
            
            // Pastikan data sekolah ada untuk mapping
            if (schoolsDataCache.length === 0) {
                const { data: schools } = await supabase.from('schools').select('*');
                schoolsDataCache = schools || [];
            }

            let query = supabase.from('users').select('*').eq('role', 'wali_kelas');

            // LOGIKA FILTER
            if (currentUser.specific_role === 'admin_sekolah') {
                query = query.eq('school_id', currentUser.school_id);
            }

            const { data: teachers } = await query.order('name', { ascending: true });
            setLoader(false);
            
            const container = document.getElementById('admin-teacher-table-body');
            if(!container) return;
            container.innerHTML = '';

            if(!teachers || teachers.length === 0) {
                container.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Belum ada guru.</td></tr>';
            } else {
                teachers.forEach(t => {
                    const school = schoolsDataCache.find(sch => sch.id == t.school_id);
                    const schoolName = school ? school.school_name : '-';
                    const statusColor = t.status === 'active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600';

                    container.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                            <td class="p-4 font-bold text-gray-800">${t.name}</td>
                            <td class="p-4 text-gray-600 text-sm">${t.email || '-'}</td>
                            <td class="p-4 text-gray-600 text-sm">${schoolName}</td>
                            <td class="p-4"><span class="${statusColor} px-2 py-1 rounded text-xs font-bold uppercase">${t.status || 'active'}</span></td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2 relative z-10">
                                    <button type="button" onclick="window.openTeacherModal('${t.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded transition cursor-pointer relative z-50">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" onclick="window.deleteTeacher('${t.id}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition cursor-pointer relative z-50">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            if(document.getElementById('stat-teacher-count')) document.getElementById('stat-teacher-count').innerText = teachers ? teachers.length : 0;
        }

        async function fetchAndRenderClassCount() {
            setLoader(true);
            
            let query = supabase.from('classes').select('*', { count: 'exact', head: true });

            // Filter berdasarkan sekolah jika Admin Sekolah yang login
            if (currentUser.specific_role === 'admin_sekolah') {
                query = query.eq('school_id', currentUser.school_id);
            }
            
            // Gunakan count() dari Supabase untuk efisiensi
            const { count, error } = await query;
            
            setLoader(false);

            if (error) {
                console.error("Error fetching class count:", error);
                if(document.getElementById('stat-class-count')) document.getElementById('stat-class-count').innerText = 'Err';
                return;
            }

            // Update elemen HTML
            if(document.getElementById('stat-class-count')) document.getElementById('stat-class-count').innerText = count !== null ? count : 0;
        }

        async function fetchAndRenderClasses() {
            setLoader(true);

            // 1. Ambil Data Sekolah (Cache)
            if (schoolsDataCache.length === 0) {
                const { data: schools } = await supabase.from('schools').select('*');
                schoolsDataCache = schools || [];
            }

            // 2. Query Kelas
            let query = supabase.from('classes').select('*');
            if (currentUser.specific_role === 'admin_sekolah') {
                query = query.eq('school_id', currentUser.school_id);
            }
            const { data: classes } = await query.order('class_name', { ascending: true });

            // 3. Ambil Mapping Wali Kelas (teachers_maps)
            const { data: maps } = await supabase.from('teachers_maps').select('*');
            
            // 4. Ambil Data Guru (untuk menampilkan nama)
            const { data: allTeachers } = await supabase.from('users').select('id, name').eq('role', 'wali_kelas');

            setLoader(false);

            const container = document.getElementById('admin-class-table-body');
            if(!container) return;
            container.innerHTML = '';

            if(!classes || classes.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">Belum ada kelas.</td></tr>';
            } else {
                classes.forEach(c => {
                    // Cari Nama Sekolah
                    const school = schoolsDataCache.find(sch => sch.id == c.school_id);
                    const schoolName = school ? school.school_name : '-';

                    // Cari Wali Kelas via teachers_maps
                    const map = maps ? maps.find(m => m.class_id == c.id) : null;
                    let teacherName = '<span class="text-gray-400 text-xs italic">Belum ditentukan</span>';
                    
                    if (map) {
                        const teacher = allTeachers ? allTeachers.find(t => t.id == map.user_id) : null;
                        if (teacher) teacherName = teacher.name;
                    }

                    container.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                            <td class="p-4 font-bold text-gray-800">${c.class_name}</td>
                            <td class="p-4 text-gray-600 text-sm">${schoolName}</td>
                            <td class="p-4 font-medium text-gray-700">${teacherName}</td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2 relative z-10">
                                    <!-- TOMBOL BARU: Buka halaman detail murid kelas -->
                                    <button type="button" onclick="window.openClassMembersView('${c.id}', '${c.class_name}')" class="text-green-500 hover:text-green-700 bg-green-50 hover:bg-green-100 p-2 rounded transition cursor-pointer relative z-50" title="Daftar Murid Kelas">
                                        <i class="fas fa-users"></i> 
                                    </button>
                                    <button type="button" onclick="window.openClassModal('${c.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded transition cursor-pointer relative z-50">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" onclick="window.deleteClass('${c.id}')" class="text-red-400 hover:text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition cursor-pointer relative z-50">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
        }
        
        // --- MANAJEMEN ANGGOTA KELAS (Halaman Baru) ---

        window.openClassMembersView = async function(classId, className) {
            currentClassId = classId;
            currentClassName = className;
            
            // Ganti View ke halaman detail
            switchAdminTab('class-members');
            document.getElementById('admin-page-title').innerText = `Kelas ${className} - Anggota`; // Perbaikan Judul
            document.getElementById('class-members-title').innerText = `Daftar Murid Kelas ${className}`;
            
            // Muat data
            await fetchAndRenderClassMembers();
        };

        async function fetchAndRenderClassMembers() {
            setLoader(true);
            const tableBody = document.getElementById('class-members-table-body');
            tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Memuat data murid...</td></tr>';

            // 1. Ambil ID murid yang ada di kelas ini
            const { data: members } = await supabase.from('students_maps')
                .select('user_id')
                .eq('class_id', currentClassId);
                
            const memberIds = members ? members.map(m => m.user_id) : [];

            // 2. Ambil detail nama murid berdasarkan ID
            if (memberIds.length > 0) {
                const { data: memberDetails } = await supabase.from('users')
                    .select('id, name')
                    .in('id', memberIds)
                    .eq('role', 'murid')
                    .order('name', { ascending: true });

                tableBody.innerHTML = '';
                if (memberDetails && memberDetails.length > 0) {
                    memberDetails.forEach((m, index) => {
                        tableBody.innerHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 text-center">${index + 1}.</td>
                                <td class="p-4 font-bold text-gray-800">${m.name}</td>
                                <td class="p-4 text-center">
                                    <button type="button" onclick="window.removeClassMember('${m.id}')" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded transition cursor-pointer relative z-50" title="Hapus dari Kelas">
                                        <i class="fas fa-trash-alt"></i> Hapus
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
            } else {
                tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Belum ada murid di kelas ini.</td></tr>';
            }
            setLoader(false);
        }

        window.removeClassMember = async function(studentId) {
            if (!confirm(`Yakin ingin mengeluarkan murid ini dari Kelas ${currentClassName}?`)) return;

            setLoader(true);
            try {
                // Hapus mapping murid dari kelas ini
                const { error } = await supabase.from('students_maps')
                    .delete()
                    .eq('class_id', currentClassId)
                    .eq('user_id', studentId);

                if (error) throw error;
                
                showToast("Murid berhasil dikeluarkan dari kelas.");
                await fetchAndRenderClassMembers(); // Reload daftar
                
            } catch (error) {
                console.error("Error removing class member:", error);
                showToast("Gagal mengeluarkan murid.");
            } finally {
                setLoader(false);
            }
        };

        window.openStudentAssignmentModal = async function() {
            const modal = document.getElementById('studentAssignmentModal');
            const titleEl = document.getElementById('assignment-modal-classname');
            const select = document.getElementById('select_unassigned_student_only');
            const submitButton = document.getElementById('submit-assign-student');

            if(!modal) return;
            titleEl.innerText = `Ke Kelas ${currentClassName}`;

            // Tampilkan Modal
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            document.body.classList.add('modal-active');
            
            // Load Dropdown Murid
            select.innerHTML = '<option value="">Memuat Murid...</option>';
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50');
            
            setLoader(true);

            // 1. Ambil ID murid yang SUDAH terdaftar di KELAS MANAPUN (Assigned IDs)
            // Kami mencari semua mapping yang memiliki user_id
            const { data: studentsInClasses } = await supabase.from('students_maps').select('user_id'); 
            
            // Buat Set untuk pengecekan cepat di JavaScript
            const assignedIdsSet = new Set(studentsInClasses ? studentsInClasses.map(s => s.user_id) : []);

            // 2. Query Murid Dasar (Ambil SEMUA Murid yang eligible di sekolah ini, TANPA FILTER ASSIGNMENT)
            let studentQuery = supabase.from('users')
                .select('id, name')
                .eq('role', 'murid')
                .eq('school_id', currentUser.school_id) // Filter sesuai sekolah admin
                .eq('status', 'active');

            const { data: allStudents } = await studentQuery.order('name', { ascending: true });
            
            setLoader(false);

            // 3. FILTER DI JAVASCRIPT (Kunci Stabilitas)
            // Murid yang belum ada di assignedIdsSet adalah murid yang unassigned.
            const unassignedStudents = allStudents 
                ? allStudents.filter(s => !assignedIdsSet.has(s.id))
                : [];


            // --- RENDER DROPDOWN ---
            select.innerHTML = '<option value="">Pilih Murid untuk ditambahkan</option>';
            
            if (unassignedStudents.length > 0) {
                unassignedStudents.forEach(s => {
                    select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
                
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50');
            } else {
                select.innerHTML = '<option value="" disabled>Semua murid sudah punya kelas.</option>';
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50');
            }
        }

        window.closeStudentAssignmentModal = function() {
            const modal = document.getElementById('studentAssignmentModal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.handleAssignStudent = async function(e) {
            e.preventDefault();
            const studentId = document.getElementById('select_unassigned_student_only').value;

            if (!studentId || !currentClassId) return;

            setLoader(true);
            try {
                // Hapus dari kelas lama (jika ada - ini penting sebagai langkah pencegahan)
                // Karena kita hanya menampilkan murid UNASSIGNED, langkah ini bisa diabaikan.
                // Namun, kita tetap jalankan untuk memastikan integritas data.
                // await supabase.from('students_maps').delete().eq('user_id', studentId); 
                
                // Tambahkan ke kelas baru
                const payload = {
                    class_id: currentClassId,
                    user_id: studentId
                };
                const { error } = await supabase.from('students_maps').insert([payload]);

                if (error) throw error;

                showToast("Murid berhasil ditambahkan.");
                window.closeStudentAssignmentModal();
                await fetchAndRenderClassMembers(); // Reload daftar murid di halaman
                
            } catch (error) {
                console.error("Error assigning student:", error);
                showToast("Gagal menambahkan murid.");
            } finally {
                setLoader(false);
            }
        };

        // --- FUNGSI MODAL LAMA LAINNYA ---
        
        window.openStudentModal = function(studentId = null) {
            const modal = document.getElementById('studentModal');
            const content = document.getElementById('studentModalContent');
            const form = document.getElementById('studentForm');
            const title = document.getElementById('studentModalTitle');
            const schoolSelect = document.getElementById('input_student_school');
            const schoolContainer = document.getElementById('div_student_school_container');

            if(!modal || !form) return;

            // Logika Sekolah
            if (currentUser.specific_role === 'admin_sekolah') {
                if(schoolContainer) schoolContainer.classList.add('hidden');
                if(schoolSelect) schoolSelect.removeAttribute('required');
            } else {
                if(schoolContainer) schoolContainer.classList.remove('hidden');
                if(schoolSelect) schoolSelect.setAttribute('required', 'true');

                if(schoolsDataCache.length === 0) {
                    fetchAndRenderSchools(); 
                }
                schoolSelect.innerHTML = '<option value="">Pilih Sekolah...</option>';
                schoolsDataCache.forEach(school => {
                    schoolSelect.innerHTML += `<option value="${school.id}">${school.school_name}</option>`;
                });
            }

            form.reset();
            
            if (studentId) {
                editingStudentId = studentId;
                if(title) title.innerText = "Edit Data Murid";
                
                setLoader(true);
                supabase.from('users').select('*').eq('id', studentId).single()
                    .then(res => {
                        setLoader(false);
                        const student = res.data;
                        if (student) {
                            if(document.getElementById('input_student_name')) document.getElementById('input_student_name').value = student.name || '';
                            if(document.getElementById('input_student_email')) document.getElementById('input_student_email').value = student.email || '';
                            if(document.getElementById('input_student_school')) document.getElementById('input_student_school').value = student.school_id || '';
                            if(document.getElementById('input_student_status')) document.getElementById('input_student_status').value = student.status || 'active';
                            if(document.getElementById('input_student_password')) document.getElementById('input_student_password').placeholder = "(Kosongkan jika tidak ubah)";
                        }
                    })
                    .catch(err => {
                        setLoader(false);
                        console.error("Error loading student data:", err);
                    });
            } else {
                editingStudentId = null;
                if(title) title.innerText = "Tambah Murid Baru";
                if(document.getElementById('input_student_password')) document.getElementById('input_student_password').placeholder = "Password Login";
            }

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            if(content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
            document.body.classList.add('modal-active');
        };

        window.closeStudentModal = function() {
            const modal = document.getElementById('studentModal');
            const content = document.getElementById('studentModalContent');
            if(!modal) return;
            modal.classList.add('opacity-0');
            if(content) content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.handleStudentSubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const email = formData.get('email');
            const password = formData.get('password');
            let school_id = formData.get('school_id');
            const status = formData.get('status');
            
            // Otomatis isi sekolah jika Admin Sekolah
            if (currentUser.specific_role === 'admin_sekolah') {
                school_id = currentUser.school_id;
            }

            setLoader(true);
            let error = null;
            let userId = editingStudentId;

            try {
                // 1. Jika Murid Baru -> Buat Akun Auth
                if (!editingStudentId) {
                    if(!password || password.length < 6) {
                         setLoader(false);
                         return alert("Password minimal 6 karakter.");
                    }

                    // Gunakan Client Sementara agar Admin tidak logout
                    const tempSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: { persistSession: false }
                    });

                    const { data: authData, error: authError } = await tempSupabase.auth.signUp({
                        email: email,
                        password: password
                    });

                    if(authError) throw authError;
                    if(!authData.user) throw new Error("Gagal register Auth.");

                    userId = authData.user.id;
                }

                // 2. Simpan ke Tabel Public Users
                const payload = {
                    name: name,
                    email: email,
                    school_id: school_id,
                    role: 'murid',
                    status: status
                };

                if (editingStudentId) {
                    const res = await supabase.from('users').update(payload).eq('id', userId);
                    error = res.error;
                } else {
                    payload.id = userId;
                    const res = await supabase.from('users').insert([payload]);
                    error = res.error;
                }

            } catch(err) {
                error = err;
            }

            setLoader(false);

            if(error) {
                showToast("Gagal: " + (error.message || "Error Database"));
                console.error(error);
            } else {
                window.closeStudentModal();
                showToast("Data murid tersimpan");
                fetchAndRenderStudents('admin');
            }
        };

        window.deleteStudent = async function(id) {
            if(!confirm('Hapus murid ini?')) return;
            setLoader(true);
            await supabase.from('users').delete().eq('id', id);
            setLoader(false);
            fetchAndRenderStudents('admin');
        };

        // --- FUNGSI MODAL IMPORT MURID ---
        window.openImportStudentModal = function() {
            const modal = document.getElementById('importStudentModal');
            const content = document.getElementById('importStudentModalContent');
            const form = document.getElementById('importStudentForm');

            if(!modal || !form) return;
            form.reset();

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            if(content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
            document.body.classList.add('modal-active');
        };

        window.closeImportStudentModal = function() {
            const modal = document.getElementById('importStudentModal');
            const content = document.getElementById('importStudentModalContent');
            if(!modal) return;
            modal.classList.add('opacity-0');
            if(content) content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.handleImportStudentSubmit = async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('import_file_input');
            const file = fileInput.files[0];

            if (!file) {
                showToast("Pilih file Excel terlebih dahulu.", true);
                return;
            }

            if (!currentUser.school_id) {
                showToast("Admin tidak terikat dengan sekolah manapun.", true);
                return;
            }
            
            setLoader(true);
            
            // --- MEMBACA FILE EXCEL MENGGUNAKAN FILEREADER DAN SHEETJS ---
            const promise = new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0]; // Ambil sheet pertama
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Konversi sheet ke JSON (header menjadi kunci, baris menjadi objek)
                        // Kita asumsikan baris pertama adalah header, tapi kita hanya butuh Nama, Email, Password.
                        const records = XLSX.utils.sheet_to_json(worksheet, { header: ["name", "email", "password"], range: 1 });
                        
                        // Filter records agar hanya yang memiliki 3 data yang valid yang diproses
                        const validRecords = records.filter(r => r.name && r.email && r.password);
                        
                        resolve(validRecords);
                    } catch (error) {
                        reject(new Error("Gagal membaca file Excel. Pastikan format benar."));
                    }
                };

                reader.onerror = (error) => {
                    reject(new Error("Gagal memuat file: " + error.message));
                };

                reader.readAsArrayBuffer(file);
            });
            
            let records = [];
            try {
                records = await promise;
            } catch (error) {
                setLoader(false);
                showToast(error.message, true);
                return;
            }

            // --- LOGIKA BULK INSERT DATA (Sama seperti sebelumnya) ---
            
            if (records.length === 0) {
                setLoader(false);
                showToast("Tidak ada data murid valid ditemukan di sheet pertama.", true);
                return;
            }
            
            if (records.length > 50) { 
                setLoader(false);
                showToast("Import dibatasi maksimal 50 baris sekaligus.", true);
                return;
            }

            let successCount = 0;
            let failedRecords = [];
            const schoolId = currentUser.school_id;
            const tempSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: { persistSession: false }
            });

            for (const record of records) {
                try {
                    // 1. Validasi Minimum
                    if (!record.email || !record.name || (record.password?.length < 6)) {
                        throw new Error("Data tidak lengkap atau password kurang dari 6 karakter.");
                    }
                    
                    // 2. Buat Akun Auth Supabase
                    const { data: authData, error: authError } = await tempSupabase.auth.signUp({
                        email: record.email,
                        password: String(record.password) // Pastikan password adalah string
                    });
                    
                    if (authError) throw authError;
                    if (!authData.user) throw new Error("Gagal mendapatkan User ID dari Auth.");
                    
                    const userId = authData.user.id;
                    
                    // 3. Simpan Detail ke Tabel Users (Role Murid)
                    const payload = {
                        id: userId,
                        name: String(record.name),
                        email: record.email,
                        school_id: schoolId,
                        role: 'murid',
                        status: 'active'
                    };

                    const { error: insertError } = await supabase.from('users').insert([payload]);
                    if (insertError) throw insertError;
                    
                    successCount++;

                } catch (error) {
                    console.error(`Gagal import ${record.email}:`, error);
                    failedRecords.push(`${record.name} (${record.email}): ${error.message || error}`);
                }
            }

            setLoader(false);
            window.closeImportStudentModal();
            fetchAndRenderStudents('admin');

            if (failedRecords.length > 0) {
                let message = `Import Selesai: ${successCount} berhasil, ${failedRecords.length} gagal.`;
                message += ` Gagal: ${failedRecords.slice(0, 3).join('; ')}...`;
                showToast(message, true);
            } else {
                showToast(`Import Berhasil! ${successCount} murid baru ditambahkan.`);
            }
        };
        // BATAS MODAL UPLOAD DATA MURID

        window.openTeacherModal = async function(teacherId = null) {
            const modal = document.getElementById('teacherModal');
            const content = document.getElementById('teacherModalContent');
            const form = document.getElementById('teacherForm');
            const title = document.getElementById('teacherModalTitle');
            const schoolSelect = document.getElementById('input_teacher_school');
            const schoolContainer = document.getElementById('div_teacher_school_container');

            if(!modal || !form) return;

            // Logika Sekolah (Sama seperti Murid)
            if (currentUser.specific_role === 'admin_sekolah') {
                if(schoolContainer) schoolContainer.classList.add('hidden');
                if(schoolSelect) schoolSelect.removeAttribute('required');
            } else {
                if(schoolContainer) schoolContainer.classList.remove('hidden');
                if(schoolSelect) schoolSelect.setAttribute('required', 'true');

                if(schoolsDataCache.length === 0) await fetchAndRenderSchools(); 
                schoolSelect.innerHTML = '<option value="">Pilih Sekolah...</option>';
                schoolsDataCache.forEach(school => {
                    schoolSelect.innerHTML += `<option value="${school.id}">${school.school_name}</option>`;
                });
            }

            form.reset();
            
            if (teacherId) {
                editingTeacherId = teacherId;
                if(title) title.innerText = "Edit Data Guru";
                
                setLoader(true);
                const { data: teacher } = await supabase.from('users').select('*').eq('id', teacherId).single();
                setLoader(false);

                if (teacher) {
                    if(document.getElementById('input_teacher_name')) document.getElementById('input_teacher_name').value = teacher.name || '';
                    if(document.getElementById('input_teacher_email')) document.getElementById('input_teacher_email').value = teacher.email || '';
                    if(document.getElementById('input_teacher_school')) document.getElementById('input_teacher_school').value = teacher.school_id || '';
                    if(document.getElementById('input_teacher_status')) document.getElementById('input_teacher_status').value = teacher.status || 'active';
                    if(document.getElementById('input_teacher_password')) document.getElementById('input_teacher_password').placeholder = "(Kosongkan jika tidak ubah)";
                }
            } else {
                editingTeacherId = null;
                if(title) title.innerText = "Tambah Guru Baru";
                if(document.getElementById('input_teacher_password')) document.getElementById('input_teacher_password').placeholder = "Password Login";
            }

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            if(content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
            document.body.classList.add('modal-active');
        };

        window.closeTeacherModal = function() {
            const modal = document.getElementById('teacherModal');
            const content = document.getElementById('teacherModalContent');
            if(!modal) return;
            modal.classList.add('opacity-0');
            if(content) content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.handleTeacherSubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const email = formData.get('email');
            const password = formData.get('password');
            let school_id = formData.get('school_id');
            const status = formData.get('status');
            
            // Otomatis isi sekolah jika Admin Sekolah
            if (currentUser.specific_role === 'admin_sekolah') {
                school_id = currentUser.school_id;
            }

            setLoader(true);
            let error = null;
            let userId = editingTeacherId;

            try {
                if (!editingTeacherId) {
                    if(!password || password.length < 6) {
                         setLoader(false);
                         return alert("Password minimal 6 karakter.");
                    }
                    const tempSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: { persistSession: false }
                    });
                    const { data: authData, error: authError } = await tempSupabase.auth.signUp({
                        email: email,
                        password: password
                    });
                    if(authError) throw authError;
                    if(!authData.user) throw new Error("Gagal register Auth.");
                    userId = authData.user.id;
                }

                const payload = {
                    name: name,
                    email: email,
                    school_id: school_id,
                    role: 'wali_kelas', // Set Role Wali Kelas
                    status: status
                };

                if (editingTeacherId) {
                    const res = await supabase.from('users').update(payload).eq('id', userId);
                    error = res.error;
                } else {
                    payload.id = userId;
                    const res = await supabase.from('users').insert([payload]);
                    error = res.error;
                }
            } catch(err) {
                error = err;
            }

            setLoader(false);

            if(error) {
                showToast("Gagal: " + (error.message || "Error Database"));
                console.error(error);
            } else {
                window.closeTeacherModal();
                showToast("Data guru tersimpan");
                fetchAndRenderTeachers();
            }
        };

        window.deleteTeacher = async function(id) {
            if(!confirm('Hapus guru ini?')) return;
            setLoader(true);
            await supabase.from('users').delete().eq('id', id);
            setLoader(false);
            fetchAndRenderTeachers();
        };

        window.openClassModal = async function(classId = null) {
            const modal = document.getElementById('classModal');
            const content = document.getElementById('classModalContent');
            const form = document.getElementById('classForm');
            const title = document.getElementById('classModalTitle');
            const schoolSelect = document.getElementById('input_class_school');
            const schoolContainer = document.getElementById('div_class_school_container');
            const teacherSelect = document.getElementById('input_class_teacher');

            if(!modal || !form) return;

            // Reset opsi guru
            teacherSelect.innerHTML = '<option value="">Pilih Wali Kelas (Opsional)...</option>';

            // Logika Sekolah (Sama seperti Murid/Guru)
            if (currentUser.specific_role === 'admin_sekolah') {
                if(schoolContainer) schoolContainer.classList.add('hidden');
                if(schoolSelect) schoolSelect.removeAttribute('required');
                // Load guru sekolah admin langsung
                await window.loadTeachersForClassModal(currentUser.school_id);
            } else {
                if(schoolContainer) schoolContainer.classList.remove('hidden');
                if(schoolSelect) schoolSelect.setAttribute('required', 'true');

                if(schoolsDataCache.length === 0) await fetchAndRenderSchools(); 
                schoolSelect.innerHTML = '<option value="">Pilih Sekolah...</option>';
                schoolsDataCache.forEach(school => {
                    schoolSelect.innerHTML += `<option value="${school.id}">${school.school_name}</option>`;
                });
            }

            form.reset();
            
            if (classId) {
                editingClassId = classId;
                if(title) title.innerText = "Edit Data Kelas";
                
                setLoader(true);
                // 1. Ambil Data Kelas
                const { data: classData } = await supabase.from('classes').select('*').eq('id', classId).single();
                
                // 2. Ambil Data Wali Kelas (Mapping)
                const { data: mapData } = await supabase.from('teachers_maps').select('*').eq('class_id', classId).maybeSingle();
                
                setLoader(false);

                if (classData) {
                    if(document.getElementById('input_class_name')) document.getElementById('input_class_name').value = classData.class_name || '';
                    if(document.getElementById('input_class_school')) document.getElementById('input_class_school').value = classData.school_id || '';
                    
                    // Trigger load teachers jika Super Admin mengubah sekolah
                    if (currentUser.specific_role !== 'admin_sekolah' && classData.school_id) {
                         await window.loadTeachersForClassModal(classData.school_id);
                    }

                    if(mapData && document.getElementById('input_class_teacher')) {
                        document.getElementById('input_class_teacher').value = mapData.user_id || '';
                    }
                }
            } else {
                editingClassId = null;
                if(title) title.innerText = "Tambah Kelas Baru";
                // Jika admin sekolah, langsung load guru
                if (currentUser.specific_role === 'admin_sekolah') {
                     await window.loadTeachersForClassModal(currentUser.school_id);
                }
            }

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            if(content) {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
            document.body.classList.add('modal-active');
        };

        window.closeClassModal = function() {
            const modal = document.getElementById('classModal');
            const content = document.getElementById('classModalContent');
            if(!modal) return;
            modal.classList.add('opacity-0');
            if(content) content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.loadTeachersForClassModal = async function(schoolId) {
            if(!schoolId) return;
            const teacherSelect = document.getElementById('input_class_teacher');
            teacherSelect.innerHTML = '<option value="">Memuat...</option>';
            
            const { data: teachers } = await supabase.from('users')
                .select('id, name')
                .eq('role', 'wali_kelas')
                .eq('school_id', schoolId)
                .eq('status', 'active');
                
            teacherSelect.innerHTML = '<option value="">Pilih Wali Kelas (Opsional)...</option>';
            if(teachers) {
                teachers.forEach(t => {
                    teacherSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
            }
        };

        window.handleClassSubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const class_name = formData.get('class_name');
            let school_id = formData.get('school_id');
            const teacher_id = formData.get('teacher_id'); 

            if (currentUser.specific_role === 'admin_sekolah') {
                school_id = currentUser.school_id;
            }

            setLoader(true);
            let error = null;
            let classId = editingClassId;

            try {
                // 1. Simpan/Update Kelas (Tabel classes)
                const payload = {
                    class_name: class_name,
                    school_id: school_id
                };

                let resClass;
                if (editingClassId) {
                    resClass = await supabase.from('classes').update(payload).eq('id', editingClassId).select();
                    classId = editingClassId; // Tetap gunakan ID lama
                } else {
                    // Biarkan database membuat ID secara otomatis
                    resClass = await supabase.from('classes').insert([payload]).select();
                    
                    // Ambil ID baru yang dikembalikan oleh database
                    if (resClass.data && resClass.data.length > 0) {
                        classId = resClass.data[0].id;
                    } else {
                        throw new Error("Gagal mendapatkan ID kelas baru.");
                    }
                }

                if(resClass.error) throw resClass.error;

                // 2. Simpan/Update Mapping Guru (Tabel teachers_maps)
                
                // Hapus mapping lama dulu (agar bersih)
                await supabase.from('teachers_maps').delete().eq('class_id', classId);
                
                // Jika ada guru yang dipilih, buat mapping baru
                if (teacher_id) {
                    const mapPayload = {
                        class_id: classId,
                        user_id: teacher_id
                    };
                    const resMap = await supabase.from('teachers_maps').insert([mapPayload]);
                    if(resMap.error) console.error("Gagal mapping guru:", resMap.error);
                }

            } catch(err) {
                error = err;
            }

            setLoader(false);

            if(error) {
                showToast("Gagal: " + (error.message || "Error Database"));
                console.error(error);
            } else {
                window.closeClassModal();
                showToast("Data kelas tersimpan");
                fetchAndRenderClasses();
            }
        };

        window.deleteClass = async function(id) {
            if(!confirm('Hapus kelas ini? Data murid dan guru yang terkait akan terhapus juga.')) return;
            setLoader(true);
            // Hapus mapping dulu (dianggap tidak ada cascade delete di DB)
            await supabase.from('teachers_maps').delete().eq('class_id', id);
            await supabase.from('students_maps').delete().eq('class_id', id); // Tambahan untuk integritas
            
            const { error } = await supabase.from('classes').delete().eq('id', id);
            setLoader(false);
            if(error) showToast("Gagal menghapus");
            else fetchAndRenderClasses();
        };

        // Fungsi baru untuk menampilkan view Data Task
        function showTaskDataView() {
             // Dihapus karena sudah diganti dengan switchAdminTab('tasks')
        }

        window.openTaskModal = async function(taskId = null) {
            const modal = document.getElementById('taskModal');
            const titleEl = document.getElementById('taskModalTitle');
            const form = document.getElementById('taskForm');
            const mapContainer = document.getElementById('class-mapping-container');

            if (!modal || !form) return;

            editingTaskId = taskId;
            form.reset();
            
            // Tentukan Title Modal
            titleEl.innerText = taskId ? "Edit Task" : "Tambah Task Baru";
            setLoader(true);

            // 1. Ambil semua kelas di sekolah admin
            let classQuery = supabase.from('classes').select('id, class_name');
            if (currentUser.specific_role === 'admin_sekolah') {
                classQuery = classQuery.eq('school_id', currentUser.school_id);
            }
            const { data: classData } = await classQuery.order('class_name', { ascending: true });
            
            // 2. Ambil data mapping task yang sedang diedit (jika ada)
            let currentTask = null;
            let currentMaps = [];

            if (taskId) {
                currentTask = tasks.find(t => t.id === taskId);
                if (currentTask) {
                    // Isi Form Task Utama
                    document.getElementById('input_task_name').value = currentTask.task_name || '';
                    document.getElementById('input_task_description').value = currentTask.task_description || '';
                    document.getElementById('input_icon_name').value = currentTask.icon_name || '';
                    document.getElementById('input_color_code').value = currentTask.color_code || '';
                    currentMaps = currentTask.raw_maps || [];
                }
            }

            setLoader(false);

            // 3. Render Checkbox Mapping (Kelas + Hari)
            mapContainer.innerHTML = '';
            
            if (classData && classData.length > 0) {
                classData.forEach(c => {
                    const classId = c.id;
                    const className = c.class_name;
                    
                    let classHtml = `
                        <div class="border p-3 rounded-lg bg-white shadow-sm">
                            <h5 class="font-bold text-sm text-primary mb-2">${className}</h5>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                    `;
                    
                    // Render 7 Checkbox untuk hari Senin (1) sampai Minggu (7)
                    for (let day = 1; day <= 7; day++) {
                        const dayName = DAY_NAMES[day];
                        const mapId = `${classId}-${day}`;
                        
                        // Cek apakah sudah ter-mapping
                        const isChecked = currentMaps.some(map => 
                            map.classes.id === classId && map.day_of_week === day
                        );

                        classHtml += `
                            <label for="map_${mapId}" class="flex items-center space-x-2 p-1.5 rounded-lg border border-gray-100 cursor-pointer hover:bg-gray-50 transition ${isChecked ? 'bg-indigo-50 border-primary' : ''}">
                                <input type="checkbox" 
                                    id="map_${mapId}" 
                                    name="task_map"
                                    value="${classId}_${day}" 
                                    class="form-checkbox text-primary rounded-md"
                                    ${isChecked ? 'checked' : ''}>
                                <span class="text-gray-700">${dayName.substring(0, 3)}</span>
                            </label>
                        `;
                    }

                    classHtml += `
                            </div>
                        </div>
                    `;
                    mapContainer.innerHTML += classHtml;
                });
            } else {
                mapContainer.innerHTML = '<p class="text-sm text-red-500 text-center">Tidak ada data kelas untuk mapping. Tambahkan kelas terlebih dahulu.</p>';
                document.getElementById('submit-task-modal').disabled = true;
            }


            // Tampilkan Modal
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            document.body.classList.add('modal-active');
        };

        window.closeTaskModal = function() {
            const modal = document.getElementById('taskModal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-active');
                editingTaskId = null;
            }, 250);
        };

        window.handleTaskSubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const taskName = formData.get('task_name');
            const iconName = formData.get('icon_name');
            const colorCode = formData.get('color_code');
            const schoolId = currentUser.school_id;

            // Kumpulkan semua mapping yang dicentang
            const checkedMaps = Array.from(document.querySelectorAll('input[name="task_map"]:checked'))
                .map(checkbox => {
                    const [classId, dayOfWeek] = checkbox.value.split('_');
                    return { classId, dayOfWeek: parseInt(dayOfWeek) };
                });

            setLoader(true);
            let error = null;
            let taskId = editingTaskId;

            try {
                // --- 1. SIMPAN/UPDATE TASK UTAMA ---
                const taskPayload = {
                    school_id: schoolId,
                    task_name: taskName,
                    icon_name: iconName || null,
                    color_code: colorCode || null
                };
                
                let resTask;
                if (editingTaskId) {
                    resTask = await supabase.from('tasks').update(taskPayload).eq('id', editingTaskId).select().single();
                    taskId = editingTaskId;
                    
                } else {
                    resTask = await supabase.from('tasks').insert([taskPayload]).select().single();
                    if (resTask.data && resTask.data.id) {
                        taskId = resTask.data.id;
                    } else {
                        // Gagal insert, data tidak kembali
                        throw new Error("Gagal menyimpan task utama. Pastikan RLS di tabel 'tasks' mengizinkan operasi INSERT.");
                    }
                }

                if(resTask.error) throw resTask.error;

                // --- 2. UPDATE TASK MAPS ---
                
                // Hapus semua mapping lama untuk task ini (Metode hapus & insert untuk simplifikasi)
                await supabase.from('task_maps').delete().eq('task_id', taskId);

                // Buat payload untuk insert mapping baru
                if (checkedMaps.length > 0) {
                    const mapPayloads = checkedMaps.map(m => ({
                        task_id: taskId,
                        class_id: m.classId,
                        day_of_week: m.dayOfWeek
                    }));

                    const { error: mapError } = await supabase.from('task_maps').insert(mapPayloads);
                    if(mapError) throw mapError;
                }

                showToast("Task berhasil disimpan dan dijadwalkan.");
                window.closeTaskModal();
                await fetchTasksAndMaps(); // Reload tabel
                
            } catch (err) {
                console.error("Error saving task:", err);
                showToast("Gagal menyimpan task: " + (err.message || "Unknown error"), true);
            } finally {
                setLoader(false);
            }
        };

        window.deleteTask = async function(taskId, taskName) {
            if (!confirm(`Yakin ingin menghapus Task: ${taskName}? Semua penjadwalan (mapping) akan ikut terhapus.`)) return;

            setLoader(true);
            try {
                // Hapus mapping terkait dulu (safety measure, meskipun cascade delete harusnya bekerja)
                await supabase.from('task_maps').delete().eq('task_id', taskId);

                // Hapus task utama
                const { error } = await supabase.from('tasks').delete().eq('id', taskId);

                if (error) throw error;
                
                showToast("Task berhasil dihapus.");
                await fetchTasksAndMaps(); // Reload daftar
                
            } catch (error) {
                console.error("Error deleting task:", error);
                showToast("Gagal menghapus task.", true);
            } finally {
                setLoader(false);
            }
        };

        /**
         * Mengambil data Tasks, Task Maps, Schools, dan Classes.
         * Data akan digabungkan di sisi client (JavaScript).
         */
        async function fetchTasksAndMaps() {
            setLoader(true);
            const tableContainer = document.getElementById('task-table-container');
            tableContainer.innerHTML = '<p class="text-center text-blue-500">Mengambil data tasks...</p>';
            
            try {
                // Tentukan filter berdasarkan role admin
                let queryTasks = supabase.from('tasks').select(`
                    id, task_name, icon_name, color_code,
                    schools (school_name)
                `);

                if (currentUser.specific_role === 'admin_sekolah') {
                    queryTasks = queryTasks.eq('school_id', currentUser.school_id);
                }

                // 1. Ambil data Tasks utama
                const { data: tasksData, error: tasksError } = await queryTasks;
                
                if (tasksError) throw tasksError;
                
                // 2. Ambil semua Task Maps
                // Filter maps berdasarkan task_id yang ada di tasksData (untuk efisiensi)
                const taskIds = tasksData.map(t => t.id);
                
                const { data: mapsData, error: mapsError } = await supabase.from('task_maps')
                    .select(`
                        task_id, day_of_week, 
                        classes (class_name)
                    `)
                    .in('task_id', taskIds);
                    
                if (mapsError) throw mapsError;
                
                // 3. Gabungkan data (Tasks + Maps)
                const combinedTasks = tasksData.map(task => {
                    // Filter task maps yang relevan dengan task ini
                    const relevantMaps = mapsData.filter(map => map.task_id === task.id);
                    
                    // Kumpulkan daftar Hari dan Kelas yang unik
                    const classesMap = new Map(); // { class_name: [day_of_week, ...] }
                    
                    relevantMaps.forEach(map => {
                        const className = map.classes.class_name;
                        const day = map.day_of_week;
                        
                        if (!classesMap.has(className)) {
                            classesMap.set(className, new Set()); // Gunakan Set untuk hari unik
                        }
                        classesMap.get(className).add(day);
                    });
                    
                    // Format Kemunculan (Hari) dan Kelas
                    let appearanceText = [];
                    classesMap.forEach((daysSet, className) => {
                        // Konversi angka hari menjadi nama hari
                        const sortedDays = Array.from(daysSet).sort((a, b) => a - b);
                        const dayNames = sortedDays.map(d => DAY_NAMES[d]).join(', ');
                        appearanceText.push(`[${className}] pada: ${dayNames}`);
                    });
                    
                    return {
                        ...task,
                        school_name: task.schools?.school_name || '-',
                        full_appearance: appearanceText.join('; '),
                        raw_maps: relevantMaps 
                    };
                });

                tasks = combinedTasks;
                renderTaskTable(tasks);

            } catch (error) {
                console.error("Error fetching tasks:", error);
                tableContainer.innerHTML = `<p class="text-center text-red-500">Gagal memuat data tasks: ${error.message}</p>`;
            } finally {
                setLoader(false);
            }
        }

        /**
         * Merender tabel HTML dari data tasks yang sudah diproses.
         */
        function renderTaskTable(tasks) {
            const tableContainer = document.getElementById('task-table-container');
            
            if (tasks.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Belum ada data tugas yang ditambahkan.</p>';
                return;
            }

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Task</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sekolah</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kemunculan (Kelas & Hari)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Icon & Warna</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            tasks.forEach((task, index) => {
                const iconHtml = task.icon_name ? `<i class="${task.icon_name} ${task.color_code || 'text-gray-500'} mr-1"></i>` : '-';
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${task.task_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.school_name}</td>
                        <td class="px-6 py-4 text-sm text-gray-700 max-w-sm whitespace-normal">${task.full_appearance || '<span class="text-red-500">Belum di-Map</span>'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="inline-flex items-center text-xs">
                                ${iconHtml} ${task.color_code || ''}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-primary hover:text-[#694cd1] mr-2" onclick="window.openTaskModal('${task.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="text-red-600 hover:text-red-900" onclick="window.deleteTask('${task.id}', '${task.task_name}')">
                                <i class="fas fa-trash-alt"></i> Hapus
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        // --- FUNGSI PENGATURAN (SETTINGS) ---
        async function renderSettingsView() {
            // 1. Render Profil Admin (Selalu Tampil)
            const roleLabel = currentUser.specific_role === 'super_admin' ? 'Super Admin' : 'Admin Sekolah';
            document.getElementById('admin-setting-name').innerText = currentUser.name;
            document.getElementById('admin-setting-role').innerText = roleLabel;
            
            // Asumsi email admin diambil dari data users (kita belum menyimpan email di currentUser, jadi kita fetch sebentar)
            const { data: userDetails } = await supabase.from('users').select('email').eq('id', currentUser.id).single();
            document.getElementById('admin-setting-email').innerText = userDetails?.email || 'N/A';

            const schoolProfileContainer = document.getElementById('school-profile-container');
            const editSchoolBtn = document.getElementById('edit-school-btn');
            
            // 2. Render Profil Sekolah (Hanya untuk Admin Sekolah)
            if (currentUser.specific_role === 'admin_sekolah' && currentUser.school_id) {
                schoolProfileContainer.classList.remove('hidden');
                editSchoolBtn.classList.remove('hidden');
                
                setLoader(true);
                const { data: school, error } = await supabase.from('schools').select('*').eq('id', currentUser.school_id).single();
                setLoader(false);

                const detailsContainer = document.getElementById('school-details');
                detailsContainer.innerHTML = '';

                if (error || !school) {
                    detailsContainer.innerHTML = '<p class="text-red-500 col-span-2">Gagal memuat data sekolah.</p>';
                    return;
                }
                
                const statusColor = school.status === 'active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600';
                
                detailsContainer.innerHTML = `
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase">Nama Sekolah</p>
                        <p class="font-bold text-gray-800">${school.school_name}</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase">Status</p>
                        <span class="font-bold ${statusColor} px-2 py-0.5 rounded text-xs">${school.status}</span>
                    </div>
                    <div class="md:col-span-2">
                        <p class="text-xs font-medium text-gray-500 uppercase">Alamat Lengkap</p>
                        <p class="font-bold text-gray-800">${school.address}</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase">Kota</p>
                        <p class="font-bold text-gray-800">${school.city}</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase">Kepala Sekolah</p>
                        <p class="font-bold text-gray-800">${school.principal_name}</p>
                    </div>
                `;
                
            } else {
                // Super Admin tidak perlu melihat Profil Sekolah
                schoolProfileContainer.classList.add('hidden');
            }
        }

        // --- FUNGSI UBAH PASSWORD ---

        window.openPasswordChangeModal = function() {
            const modal = document.getElementById('passwordChangeModal');
            const form = document.getElementById('passwordChangeForm');
            
            if(!modal || !form) return;
            form.reset();
            
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            document.body.classList.add('modal-active');
        };

        window.closePasswordChangeModal = function() {
            const modal = document.getElementById('passwordChangeModal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-active');
            }, 250);
        };

        window.handlePasswordChange = async function(e) {
            e.preventDefault();
            const newPassword = document.getElementById('input_new_password').value;
            const confirmPassword = document.getElementById('input_confirm_password').value;

            if (newPassword !== confirmPassword) {
                showToast("Konfirmasi password tidak cocok!", true);
                return;
            }
            
            if (newPassword.length < 6) {
                showToast("Password minimal 6 karakter.", true);
                return;
            }

            setLoader(true);
            
            // Supabase menggunakan auth.updateUser untuk mengubah password user yang sedang login
            const { error } = await supabase.auth.updateUser({ 
                password: newPassword 
            });
            
            setLoader(false);

            if (error) {
                console.error("Password change failed:", error);
                showToast("Gagal mengubah password. Anda mungkin harus login ulang.", true);
            } else {
                window.closePasswordChangeModal();
                showToast("Password berhasil diubah!");
                // Opsional: Langsung logout untuk memaksa login dengan password baru
                // setTimeout(() => window.logout(), 2000); 
            }
        };

        // --- FUNGSI PARENT/MURID VIEW ---
        window.renderParentView = async function(dateObj = currentViewDate) {
            setLoader(true);
            currentViewDate = dateObj; // Update tanggal yang sedang dilihat

            // --- 1. DATA TANGGAL YANG DIPILIH (UNTUK FILTER) ---
            const selectedDate = dateObj;
            // Tentukan hari (1=Senin, 7=Minggu) berdasarkan tanggal yang dipilih
            const selectedDay = selectedDate.getDay() === 0 ? 7 : selectedDate.getDay(); 
            const selectedDateISO = selectedDate.toISOString().split('T')[0]; // Format YYYY-MM-DD

            // --- 2. DATA TANGGAL HARI INI (UNTUK HEADER TETAP) ---
            const today = new Date();
            const todayFormattedDate = today.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });


            // Set Date Picker dan Header Info
            const datePicker = document.getElementById('date-picker-parent');
            if (datePicker) datePicker.value = selectedDateISO;
            
            document.getElementById('parent-view-name').innerText = currentUser.name;
            document.getElementById('parent-date').innerText = todayFormattedDate; // <-- PERBAIKAN: Selalu gunakan todayFormattedDate

            const checklistResult = document.getElementById('parent-checklist-result');
            checklistResult.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-sm border"><i class="fas fa-spinner fa-spin text-primary text-2xl mb-3"></i><p class="text-sm text-gray-600">Memuat data...</p></div>`;
            const noteDisplay = document.getElementById('parent-note-display');
            noteDisplay.classList.add('hidden');
            document.getElementById('parent-note-text').innerText = '';

            try {
                // A. Cari tahu Murid ada di Kelas Mana
                const { data: mapData } = await supabase.from('students_maps')
                    .select('class_id, classes(class_name)')
                    .eq('user_id', currentUser.id)
                    .maybeSingle(); 
                    
                if (!mapData || !mapData.classes) {
                    document.getElementById('parent-class-name').innerText = 'Tidak terdaftar di kelas manapun';
                    checklistResult.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-sm border"><p class="text-sm text-red-600">Anda belum terdaftar di kelas manapun.</p></div>`;
                    setLoader(false);
                    return;
                }

                const classId = mapData.class_id;
                const className = mapData.classes.class_name;
                document.getElementById('parent-class-name').innerText = `Kelas: ${className}`;

                // B. Ambil Jadwal Task UNTUK HARI YANG DIPILIH
                const { data: scheduleData } = await supabase.from('task_maps')
                    .select('task_id, tasks(*)')
                    .eq('class_id', classId)
                    .eq('day_of_week', selectedDay); // Filter sesuai hari yang dipilih (berdasarkan selectedDate)

                const todayTasks = scheduleData ? scheduleData.map(s => s.tasks) : [];

                // C. Ambil Data Daily Activity (Hasil Ceklis dan Note) UNTUK HARI YANG DIPILIH
                const { data: activityData } = await supabase.from('daily_activities')
                    .select('task_data, teacher_note')
                    .eq('student_id', currentUser.id)
                    .eq('activity_date', selectedDateISO) // Menggunakan ISO dari tanggal yang dipilih
                    .maybeSingle();
                    
                const completedTasks = activityData?.task_data || {};
                const teacherNote = activityData?.teacher_note;
                
                // --- RENDER CHECKLIST ---
                if (todayTasks.length === 0) {
                    checklistResult.innerHTML = `<div class="p-8 bg-white rounded-xl shadow-sm border"><p class="text-sm text-gray-500 text-center">Tidak ada tugas harian terjadwal untuk tanggal ini.</p></div>`;
                } else {
                    let tasksHtml = '<div class="space-y-3">';
                    
                    todayTasks.forEach(task => {
                        const isChecked = completedTasks[task.id] === true;
                        const checkColor = isChecked ? 'bg-primary border-primary' : 'bg-gray-100 border-gray-300';
                        
                        tasksHtml += `
                           <div class="flex items-center bg-white p-4 rounded-xl border ${isChecked ? 'shadow-md border-secondary' : 'border-gray-200 shadow-sm'} transition duration-200">
                                <div class="flex-shrink-0 w-10 h-10 rounded-full ${task.color_code || 'text-gray-500'} ${isChecked ? 'bg-secondary text-white' : 'bg-gray-100'} flex items-center justify-center text-lg mr-4">
                                    <i class="${task.icon_name || 'fas fa-star'}"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800">${task.task_name}</p>
                                    <p class="text-xs text-gray-500">Dicatat oleh Wali Kelas</p>
                                </div>
                                <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 ${checkColor} flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs ${isChecked ? 'opacity-100' : 'opacity-0'}"></i>
                                </div>
                            </div>
                        `;
                    });
                    tasksHtml += '</div>';
                    checklistResult.innerHTML = tasksHtml;
                }
                
                // --- RENDER NOTE ---
                if (teacherNote) {
                    document.getElementById('parent-note-text').innerText = teacherNote;
                    noteDisplay.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error rendering parent view:", error);
                checklistResult.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-sm border"><p class="text-sm text-red-600">Gagal memuat data: ${error.message}</p></div>`;
            } finally {
                setLoader(false);
            }
        };

        window.handleDateChange = function(dateString) {
            if (dateString) {
                // Buat objek Date dari string YYYY-MM-DD
                // Date() akan membuat tanggal pada 00:00:00 UTC
                const selectedDate = new Date(dateString);
                
                // PENTING: Atur waktu ke tengah hari (12:00 PM) di zona waktu lokal.
                // Ini memastikan objek tanggal berada di dalam hari yang dipilih,
                // meskipun ada konversi zona waktu lokal.
                selectedDate.setHours(12, 0, 0, 0);
                
                // Panggil fungsi render dengan tanggal baru
                window.renderParentView(selectedDate);
            }
        };

        // FUNGSI CEKLIS GURU
        window.openChecklist = function(studentId, studentName) {
            // Memperbarui state global
            currentChecklistStudentId = studentId;
            currentChecklistStudentName = studentName.replace(/'/g, ''); // Membersihkan string
            
            // Ganti View ke halaman ceklis
            switchView('view-teacher-checklist');
            document.getElementById('checklist-student-name').innerText = currentChecklistStudentName;
            
            // Inisialisasi tanggal hari ini (tengah hari) untuk ceklis
            let today = new Date();
            today.setHours(12, 0, 0, 0); 
            
            // Panggil fungsi render utama
            window.renderTeacherChecklist(today);
        };

        window.renderTeacherChecklist = async function(dateObj) {
            setLoader(true);

            const checklistContainer = document.getElementById('checklist-container');
            checklistContainer.innerHTML = `<div class="text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin text-primary text-2xl mb-3"></i><p>Memuat tugas harian...</p></div>`;
            document.getElementById('custom-note-input').value = '';
            currentDailyActivityId = null;

            // --- 1. DATA TANGGAL YANG DIPILIH ---
            const selectedDate = dateObj;
            const selectedDay = selectedDate.getDay() === 0 ? 7 : selectedDate.getDay(); 
            const selectedDateISO = selectedDate.toISOString().split('T')[0]; // Format YYYY-MM-DD
            
            // Set Date Picker
            document.getElementById('date-picker-teacher').value = selectedDateISO;

            try {
                // Asumsi: currentClassId sudah diset saat login guru di fetchAndRenderStudents()
                const classId = currentClassId;
                const studentId = currentChecklistStudentId;
                
                if (!classId) {
                    checklistContainer.innerHTML = `<div class="text-center py-10 text-red-500"><p>Guru belum terdaftar di kelas manapun.</p></div>`;
                    setLoader(false);
                    return;
                }

                // --- 2. AMBIL JADWAL TASK HARI INI ---
                const { data: scheduleData } = await supabase.from('task_maps')
                    .select('task_id, tasks(id, task_name, icon_name, color_code)')
                    .eq('class_id', classId)
                    .eq('day_of_week', selectedDay); 

                const todayTasks = scheduleData ? scheduleData.map(s => s.tasks) : [];

                // --- 3. AMBIL DATA DAILY ACTIVITY (CEKLIS & NOTE) ---
                const { data: activity, error: activityError } = await supabase.from('daily_activities')
                    .select('*')
                    .eq('student_id', studentId)
                    .eq('activity_date', selectedDateISO)
                    .maybeSingle();

                if (activityError) throw activityError;

                const completedTasks = activity?.task_data || {};
                currentDailyActivityId = activity?.id || null;
                
                // Isi Catatan
                document.getElementById('custom-note-input').value = activity?.teacher_note || '';

                // --- 4. RENDER CEKLIS INTERAKTIF ---
                if (todayTasks.length === 0) {
                    checklistContainer.innerHTML = `<div class="p-8 bg-white rounded-xl shadow-sm border"><p class="text-sm text-gray-500 text-center">Tidak ada tugas terjadwal untuk hari ini.</p></div>`;
                } else {
                    let tasksHtml = '<div class="space-y-4">';
                    
                    todayTasks.forEach(task => {
                        const isChecked = completedTasks[task.id] === true;
                        const checkboxId = `task-check-${task.id}`;
                        
                        tasksHtml += `
                            <label for="${checkboxId}" class="block cursor-pointer">
                                <input type="checkbox" id="${checkboxId}" class="ceklis-checkbox hidden" 
                                    onchange="window.handleCheckChange('${task.id}', this.checked)"
                                    ${isChecked ? 'checked' : ''}>
                                
                                <div class="flex items-center bg-white p-4 rounded-xl border-2 border-gray-200 shadow-sm transition duration-200 hover:border-gray-300">
                                    <div class="icon-box flex-shrink-0 w-10 h-10 rounded-full ${task.color_code || 'text-gray-500'} bg-gray-100 flex items-center justify-center text-lg mr-4">
                                        <i class="${task.icon_name || 'fas fa-question'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-800">${task.task_name}</p>
                                    </div>
                                    <!-- Check Indicator -->
                                    <div class="check-indicator flex-shrink-0 w-6 h-6 rounded-full border-2 border-gray-400 flex items-center justify-center text-white text-xs opacity-0 transform scale-0 transition">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                            </label>
                        `;
                    });
                    tasksHtml += '</div>';
                    checklistContainer.innerHTML = tasksHtml;
                }

            } catch (error) {
                console.error("Error rendering teacher checklist:", error);
                checklistContainer.innerHTML = `<div class="text-center py-10 text-red-500"><p>Gagal memuat data: ${error.message}</p></div>`;
            } finally {
                setLoader(false);
            }
        };

        window.handleCheckChange = async function(taskId, isChecked) {
            if (!currentChecklistStudentId || !currentClassId) return;

            setLoader(true);

            try {
                const studentId = currentChecklistStudentId;
                const selectedDateISO = document.getElementById('date-picker-teacher').value;
                
                // 1. Ambil data aktivitas yang ada
                const { data: activity } = await supabase.from('daily_activities')
                    .select('id, task_data')
                    .eq('student_id', studentId)
                    .eq('activity_date', selectedDateISO)
                    .maybeSingle();

                let newTaskData = activity?.task_data || {};
                newTaskData[taskId] = isChecked;

                const payload = {
                    student_id: studentId,
                    activity_date: selectedDateISO,
                    task_data: newTaskData
                };

                if (activity) {
                    // Update record yang sudah ada
                    await supabase.from('daily_activities').update({ task_data: newTaskData }).eq('id', activity.id);
                    showToast("Ceklis diperbarui.");
                } else {
                    // Insert record baru
                    const { data: newActivity } = await supabase.from('daily_activities').insert([payload]).select().single();
                    currentDailyActivityId = newActivity.id;
                    showToast("Ceklis baru disimpan.");
                }

            } catch (error) {
                console.error("Error saving checklist:", error);
                showToast("Gagal menyimpan ceklis.", true);
            } finally {
                setLoader(false);
            }
        };

        window.saveNote = async function() {
            if (!currentChecklistStudentId) return;
            
            const note = document.getElementById('custom-note-input').value;
            const studentId = currentChecklistStudentId;
            const selectedDateISO = document.getElementById('date-picker-teacher').value;

            setLoader(true);

            try {
                const payload = {
                    student_id: studentId,
                    activity_date: selectedDateISO,
                    teacher_note: note
                };

                if (currentDailyActivityId) {
                    // Update record yang sudah ada
                    await supabase.from('daily_activities').update({ teacher_note: note }).eq('id', currentDailyActivityId);
                    showToast("Catatan diperbarui.");
                } else {
                    // Insert record baru (jika belum ada ceklis)
                    const { data: newActivity } = await supabase.from('daily_activities').insert([payload]).select().single();
                    currentDailyActivityId = newActivity.id;
                    showToast("Catatan baru disimpan.");
                }

            } catch (error) {
                console.error("Error saving note:", error);
                showToast("Gagal menyimpan catatan.", true);
            } finally {
                setLoader(false);
            }
        };

        // FUNGSI HALAMAN PROFIL PARENT
        window.renderParentProfile = async function() {
            // Pindah ke view profil
            switchView('view-parent-profile');
            setLoader(true);

            try {
                const studentId = currentUser.id;
                
                document.getElementById('profile-page-title').innerText = 'Profil Anak & Akun';
                document.getElementById('profile-data-title').innerText = 'Data Anak';
                document.getElementById('profile-name-label').innerText = 'NAMA ANAK';

                // 1. Ambil detail murid dan email (langsung dari currentUser yang dimuat saat login)
                document.getElementById('profile-name').innerText = currentUser.name || '-';
                document.getElementById('profile-email').innerText = currentUser.email || '-'; 

                // 2. Ambil Nama Sekolah
                let schoolName = '-';
                if (currentUser.school_id) {
                    const { data: school } = await supabase.from('schools').select('school_name').eq('id', currentUser.school_id).maybeSingle();
                    schoolName = school?.school_name || '-';
                }
                document.getElementById('profile-school').innerText = schoolName;

                // 3. Ambil Kelas dan Wali Kelas (Mapping Berlapis)
                let className = 'Belum terdaftar';
                let teacherName = 'Belum ditentukan';

                // Cari kelas anak
                const { data: studentMap } = await supabase.from('students_maps')
                    .select('class_id, classes(class_name)')
                    .eq('user_id', studentId)
                    .maybeSingle();

                if (studentMap && studentMap.classes) {
                    className = studentMap.classes.class_name;
                    const classId = studentMap.class_id;

                    // Cari Wali Kelas yang mengampu kelas ini
                    const { data: teacherMap } = await supabase.from('teachers_maps')
                        .select('user_id')
                        .eq('class_id', classId)
                        .maybeSingle();

                    if (teacherMap) {
                        const { data: teacher } = await supabase.from('users')
                            .select('name')
                            .eq('id', teacherMap.user_id)
                            .maybeSingle();
                        
                        teacherName = teacher?.name || 'Wali Kelas Tidak Ditemukan';
                    }
                }
                
                document.getElementById('profile-class').innerText = className;
                document.getElementById('profile-teacher').innerText = teacherName;

            } catch (error) {
                console.error("Error rendering parent profile:", error);
                showToast("Gagal memuat profil: " + error.message, true);
            } finally {
                setLoader(false);
            }
        };

        // Panggil fungsi pengecekan sesi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', checkSessionAndRender);

        window.navHome = function() {
            if (currentUser && currentUser.role === 'teacher') {
                switchView('view-teacher-dashboard');
                // Tidak perlu fetch ulang data murid kecuali benar-benar dibutuhkan
            } else if (currentUser && currentUser.role === 'parent') {
                switchView('view-parent-dashboard');
                window.renderParentView(currentViewDate); // Reload data sesuai tanggal saat ini
            }
            // Anda bisa tambahkan logika untuk role lain di sini jika diperlukan
        };

        window.renderProfileBasedOnRole = function() {
            if (currentUser && currentUser.role === 'teacher') {
                window.renderTeacherProfile();
            } else if (currentUser && currentUser.role === 'parent') {
                window.renderParentProfile();
            }
        };

        window.renderTeacherProfile = async function() {
            // Fungsi ini akan sama persis dengan renderParentProfile, 
            // hanya saja data yang ditampilkan adalah data guru yang sedang login.
            switchView('view-parent-profile'); // Re-use view profil yang sama
            setLoader(true);

            try {
                // --- PERBAIKAN LABEL ---
                document.getElementById('profile-page-title').innerText = 'Profil Guru & Akun';
                document.getElementById('profile-data-title').innerText = 'Data Guru';
                document.getElementById('profile-name-label').innerText = 'NAMA GURU';
                // --- END PERBAIKAN LABEL ---

                // Asumsi data guru sudah lengkap di currentUser
                document.getElementById('profile-name').innerText = currentUser.name || '-';
                document.getElementById('profile-email').innerText = currentUser.email || '-'; 
                document.getElementById('profile-school').innerText = 'Memuat...';
                document.getElementById('profile-class').innerText = 'Memuat...';
                document.getElementById('profile-teacher').innerText = 'Anda (Wali Kelas)'; // Guru adalah wali kelasnya sendiri

                // 1. Ambil Nama Sekolah
                let schoolName = '-';
                if (currentUser.school_id) {
                    const { data: school } = await supabase.from('schools').select('school_name').eq('id', currentUser.school_id).maybeSingle();
                    schoolName = school?.school_name || '-';
                }
                document.getElementById('profile-school').innerText = schoolName;

                // 2. Ambil Kelas yang diampu Guru ini
                let className = 'Tidak Mengampu Kelas';
                const { data: teacherMap } = await supabase.from('teachers_maps')
                    .select('class_id, classes(class_name)')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (teacherMap && teacherMap.classes) {
                    className = teacherMap.classes.class_name;
                }
                
                document.getElementById('profile-class').innerText = className;
                document.getElementById('profile-teacher').innerText = 'Anda (Wali Kelas)';

            } catch (error) {
                console.error("Error rendering teacher profile:", error);
                showToast("Gagal memuat profil guru: " + error.message, true);
            } finally {
                setLoader(false);
            }
        };

    </script>
</body>
</html>

